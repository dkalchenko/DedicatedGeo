@{
    Layout = null; // standalone admin devices page styled like Users.cshtml
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Devices Management</title>

    <style>
        /* Reuse styling approach from Users.cshtml to keep visual consistency */
        html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, rgba(3,7,12,1), rgba(6,10,16,1)); color: #e6eef8; }

        .root{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:32px; box-sizing:border-box; }

        .card{
            width: min(960px, 96vw);
            margin-top:32px;
            background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98));
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(2,6,23,0.6);
            display:flex; flex-direction:column; gap:16px;
        }

        .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .card-header h1{ margin:0; font-size:18px; }
        .card-sub{ color:#9aa4b2; font-size:13px; }

        .controls{ display:flex; gap:8px; align-items:center; }
        .search{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:#e6eef8; }

        table.devices{ width:100%; border-collapse:collapse; font-size:14px; }
        table.devices thead th{ text-align:left; color:#9aa4b2; font-weight:600; padding:10px; font-size:13px; }
        table.devices tbody td{ padding:10px; border-top:1px solid rgba(255,255,255,0.02); }
        table.devices tbody tr:hover td{ background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }

        .btn-primary{
            background: linear-gradient(90deg, #7c5cff, #5ab3ff);
            border:none; color:white; padding:10px 14px; font-weight:700; border-radius:10px; cursor:pointer; font-size:14px;
            box-shadow: 0 8px 30px rgba(90,179,255,0.06);
        }
        .btn-ghost{
            background: transparent; border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600;
        }
        .btn-danger{ background: linear-gradient(180deg,#ef4444,#c81b1b); color:white; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }

        .pagination{ display:flex; gap:8px; align-items:center; }
        .page-input{ -webkit-appearance: none; -moz-appearance: none; appearance: none; padding:6px 36px 6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background-image: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)), linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.25) 50%), linear-gradient(135deg, rgba(255,255,255,0.25) 50%, transparent 50%); background-position: left top, calc(100% - 16px) calc(1em + 2px), calc(100% - 12px) calc(1em + 2px); background-size: auto, .5em .5em, .5em .5em; background-repeat: no-repeat; background-color: transparent; color:#e6eef8; cursor:pointer; box-sizing:border-box; }
        .page-input::-ms-expand{ display:none; }
        .page-input:focus{ outline:2px solid rgba(90,179,255,0.12); box-shadow: 0 6px 18px rgba(90,179,255,0.04); }
        .page-input option{ background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); color:#e6eef8; padding:6px 8px; }

        .modal-backdrop{ position:fixed; inset:0; background: rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:1400; }
        .modal-backdrop.open{ display:flex; }
        .modal-card{ width: min(700px, 96vw); background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:16px; border-radius:12px; box-shadow: 0 24px 80px rgba(2,6,23,0.6); }
        .form-row{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
        label{ color:#9aa4b2; font-size:13px; }
        input[type="text"], input[type="email"], input[type="password"], select{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border: 1px solid rgba(255,255,255,0.04); color: #e6eef8; padding: 10px 12px; border-radius: 10px; outline:none; }
        .row{ display:flex; gap:8px; align-items:center; }

        .toast-container{ position: fixed; top: 16px; right: 16px; z-index: 1600; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
        .toast{ min-width: 220px; max-width: 88vw; background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98)); color: #e6eef8; border: 1px solid rgba(255,255,255,0.04); padding: 10px 12px; border-radius: 10px; box-shadow: 0 12px 36px rgba(2,6,23,0.6); font-size:13px; display:flex; align-items:center; gap:10px; }
        .toast.error{ border-color: rgba(239,68,68,0.18); background: linear-gradient(180deg, rgba(239,68,68,0.06), rgba(11,18,28,0.95)); color:#fff2f2; }

        .spinner{ width:28px; height:28px; border-radius:999px; border:3px solid rgba(255,255,255,0.06); border-top-color:#5ab3ff; animation:spin 1s linear infinite; }
        @@keyframes spin{ to { transform:rotate(360deg); } }

        /* assigned admin badges */
        .admin-badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: linear-gradient(90deg,#5ab3ff,#2db5ff); color:#012; font-weight:700; font-size:13px; }
        .admin-remove{ background:transparent; border:none; color:#012; font-weight:800; cursor:pointer; }

        .admin-assign-list{ display:flex; flex-wrap:wrap; gap:8px; }
        .admin-search-results{ max-height:240px; overflow:auto; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); padding:8px; }
        .admin-result{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer; }
        .admin-result:hover{ background: rgba(255,255,255,0.02); }

        @@media (max-width:720px){ .card{ width:94vw; margin-top:18px; } table.devices thead{ display:none; } table.devices tbody td{ display:block; width:100%; } }
    </style>
</head>
<body>
    <main class="root" role="main">
        <section class="card" aria-labelledby="devicesTitle">
            <div class="card-header">
                <div>
                    <h1 id="devicesTitle">Device Management</h1>
                    <div class="card-sub">Create, edit, assign admins and delete devices.</div>
                </div>
                <div class="controls">
                    <input id="searchInput" class="search" placeholder="Filter by name or IMEI" />
                    <button id="createBtn" class="btn-primary">Create device</button>
                </div>
            </div>

            <div id="tableWrapper" style="position:relative;overflow:auto;">
                <div id="tableSpinner" class="spinner" aria-hidden="true" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);"></div>
                <table class="devices" id="devicesTable" aria-describedby="devicesTitle" aria-busy="false">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>IMEI</th>
                            <th>Assigned Admins</th>
                            <th style="width:200px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- populated by JS -->
                    </tbody>
                </table>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                <div class="pagination">
                    <button id="prevPage" class="btn-ghost">Previous</button>
                    <div style="display:flex;align-items:center;gap:8px;color:#9aa4b2">
                        Page <span id="currentPage">1</span>
                    </div>
                    <button id="nextPage" class="btn-ghost">Next</button>
                </div>

                <div style="display:flex;align-items:center;gap:8px;">
                    <label id="pageSizeLabel" style="color:#9aa4b2;font-size:13px;">Page size</label>
                    <select id="pageSize" class="page-input" aria-hidden="true" style="display:none;">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>

                    <div class="page-select-wrap" id="pageSizeWrap" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <div class="page-select-value" id="pageSizeDisplay">10</div>
                        <div class="page-options" id="pageSizeOptions" role="listbox" tabindex="-1">
                            <button type="button" class="page-option" data-value="10">10</button>
                            <button type="button" class="page-option" data-value="25">25</button>
                            <button type="button" class="page-option" data-value="50">50</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div>
                    <div id="modalTitle" style="font-weight:700;font-size:16px;color:#e6eef8">Create device</div>
                    <div id="modalSub" style="color:#9aa4b2;font-size:13px"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button id="modalCancel" class="btn-ghost">Cancel</button>
                    <button id="modalSave" class="btn-primary">Save</button>
                </div>
            </div>

            <form id="deviceForm" style="margin-top:12px;">
                <input type="hidden" id="deviceId" />
                <div class="form-row">
                    <label for="deviceName">Device name</label>
                    <input id="deviceName" type="text" required />
                </div>
                <div class="form-row">
                    <label for="imei">IMEI</label>
                    <input id="imei" type="text" />
                </div>

                <div class="form-row">
                    <label>Assigned admins</label>
                    <div class="admin-assign-list" id="assignedAdmins"></div>
                    <div style="margin-top:8px;">
                        <input id="adminSearch" class="search" placeholder="Search admins by email" />
                        <div id="adminResults" class="admin-search-results" style="display:none;"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
    (function(){
        function debounce(fn, wait){ let t = null; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); }; }

        const tableSpinner = document.getElementById('tableSpinner');
        function showLoading(){ if (tableSpinner) tableSpinner.style.display = ''; document.getElementById('devicesTable').setAttribute('aria-busy','true'); prevPageBtn.disabled = true; nextPageBtn.disabled = true; }
        function hideLoading(){ if (tableSpinner) tableSpinner.style.display = 'none'; document.getElementById('devicesTable').setAttribute('aria-busy','false'); }

        let lastFocusedEl = null;

        const devicesTableBody = document.querySelector('#devicesTable tbody');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const currentPageEl = document.getElementById('currentPage');
        const pageSizeEl = document.getElementById('pageSize');
        const searchInput = document.getElementById('searchInput');

        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalSave = document.getElementById('modalSave');
        const modalCancel = document.getElementById('modalCancel');
        const deviceIdEl = document.getElementById('deviceId');
        const deviceNameEl = document.getElementById('deviceName');
        const imeiEl = document.getElementById('imei');

        const createBtn = document.getElementById('createBtn');
        const toastContainer = document.getElementById('toastContainer');

        // Admin assignment UI
        const assignedAdminsRoot = document.getElementById('assignedAdmins');
        const adminSearchEl = document.getElementById('adminSearch');
        const adminResultsEl = document.getElementById('adminResults');

        let assignedAdmins = []; // array of { UserId, Email }

        // page selector custom UI (simple)
        const pageSizeWrap = document.getElementById('pageSizeWrap');
        const pageSizeOptions = document.getElementById('pageSizeOptions');
        const pageSizeDisplay = document.getElementById('pageSizeDisplay');
        const pageOptionButtons = Array.from(document.querySelectorAll('.page-option'));

        function showToast(message, { type = 'default', duration = 4000 } = {}){
            const t = document.createElement('div');
            t.className = 'toast' + (type === 'error' ? ' error' : '');
            t.setAttribute('role','status');
            t.textContent = message;
            const close = document.createElement('button'); close.type = 'button'; close.innerText = 'Close'; close.className = 'btn-ghost'; close.style.marginLeft = '8px';
            close.addEventListener('click', ()=> t.remove());
            t.appendChild(close);
            toastContainer.appendChild(t);
            if (duration > 0) setTimeout(()=>{ try{ t.remove(); }catch(e){} }, duration);
        }

        function renderAssignedAdmins(){
            assignedAdminsRoot.innerHTML = '';
            assignedAdmins.forEach(a => {
                const wrap = document.createElement('div'); wrap.className = 'admin-badge';
                const txt = document.createElement('span'); txt.innerText = a.Email ?? a.Email ?? String(a.UserId ?? a.userId ?? a.id ?? '');
                const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'admin-remove'; btn.title = 'Unassign admin'; btn.innerText = '✕';
                btn.addEventListener('click', ()=>{
                    assignedAdmins = assignedAdmins.filter(x => (x.UserId ?? x.userId ?? x.id) !== (a.UserId ?? a.userId ?? a.id));
                    renderAssignedAdmins();
                });
                wrap.appendChild(txt); wrap.appendChild(btn);
                assignedAdminsRoot.appendChild(wrap);
            });
        }

        // Admin search
        async function fetchAdmins(q){
            try{
                const searchParam = q ? `&search=${encodeURIComponent(q)}` : '';
                // try server paged endpoint similar to users list
                const url = `/v1/admin/users?offset=0&limit=50${searchParam}`;
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) return [];
                const data = await resp.json();
                if (Array.isArray(data)) return data;
                if (Array.isArray(data.Users)) return data.Users;
                if (Array.isArray(data.users)) return data.users;
                return [];
            } catch (e){ console.warn('fetchAdmins error', e); return []; }
        }

        let adminSearchToken = 0;
        const doAdminSearch = debounce(async ()=>{
            const q = (adminSearchEl.value || '').trim();
            adminResultsEl.innerHTML = '';
            if (!q){ adminResultsEl.style.display = 'none'; return; }
            adminResultsEl.style.display = '';
            const token = ++adminSearchToken;
            const results = await fetchAdmins(q);
            if (token !== adminSearchToken) return; // stale
            if (!results || results.length === 0){ adminResultsEl.innerHTML = '<div class="admin-result" style="justify-content:center;color:#9aa4b2">No admins</div>'; return; }
            results.forEach(r => {
                const id = r.UserId ?? r.userId ?? r.id ?? r.Id ?? null;
                const email = r.Email ?? r.email ?? r.EmailAddress ?? String(id ?? '');
                const row = document.createElement('div'); row.className = 'admin-result';
                const left = document.createElement('div'); left.style.overflow='hidden'; left.style.textOverflow='ellipsis'; left.style.whiteSpace='nowrap'; left.style.flex='1'; left.innerText = email;
                const btn = document.createElement('button'); btn.type='button'; btn.className='btn-ghost'; btn.innerText='Add';
                btn.addEventListener('click', ()=>{
                    // avoid duplicates
                    const exists = assignedAdmins.some(x => (x.UserId ?? x.userId ?? x.id) === id);
                    if (exists) { showToast('Admin already assigned'); return; }
                    assignedAdmins.push({ UserId: id, Email: email });
                    renderAssignedAdmins();
                });
                row.appendChild(left); row.appendChild(btn);
                adminResultsEl.appendChild(row);
            });
        }, 300);

        adminSearchEl.addEventListener('input', doAdminSearch);
        adminSearchEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); doAdminSearch(); } });

        // Modal open/close
        function openModal(mode, device){
            try { lastFocusedEl = document.activeElement; } catch (e) {}
            modalBackdrop.classList.add('open'); modalBackdrop.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
            if (mode === 'create'){
                modalTitle.innerText = 'Create device'; deviceIdEl.value = ''; deviceNameEl.value = ''; imeiEl.value = ''; assignedAdmins = []; renderAssignedAdmins(); deviceNameEl.focus();
            } else {
                modalTitle.innerText = 'Edit device';
                const id = device.DeviceId ?? device.deviceId ?? device.id ?? device.Id ?? null;
                if (!id){ deviceIdEl.value = device.DeviceId ?? device.deviceId ?? device.id ?? ''; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? ''; assignedAdmins = (device.AssignedAdmins || device.Admins || device.AdminIds || []).map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a, Email: a.Email ?? a.email ?? String(a.userId ?? a.id ?? a) })); renderAssignedAdmins(); deviceNameEl.focus(); }
                else {
                    // fetch the single device for freshest data
                    (async ()=>{
                        modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');
                        try{
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(id)}`, { cache: 'no-store' });
                            if (resp.ok){ const data = await resp.json(); const d = Array.isArray(data) ? data[0] : data; deviceIdEl.value = d.DeviceId ?? d.deviceId ?? d.id ?? id; deviceNameEl.value = d.DeviceName ?? d.deviceName ?? d.name ?? ''; imeiEl.value = d.IMEI ?? d.Imei ?? d.imei ?? ''; const adminsSrc = d.AssignedAdmins ?? d.Admins ?? d.AdminIds ?? d.admins ?? [];
                                if (Array.isArray(adminsSrc)) assignedAdmins = adminsSrc.map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a, Email: a.Email ?? a.email ?? String(a.userId ?? a.id ?? a) })); else assignedAdmins = [];
                                renderAssignedAdmins();
                            } else { showToast('Failed to load device details; using provided values', { type: 'error' }); deviceIdEl.value = id; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? ''; assignedAdmins = (device.AssignedAdmins || device.Admins || []).map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a, Email: a.Email ?? a.email ?? String(a.userId ?? a.id ?? a) })); renderAssignedAdmins(); }
                        } catch (e){ console.warn('openModal fetch device', e); deviceIdEl.value = id; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? ''; assignedAdmins = (device.AssignedAdmins || device.Admins || []).map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a, Email: a.Email ?? a.email ?? String(a.userId ?? a.id ?? a) })); renderAssignedAdmins(); }
                        finally{ modalSave.disabled = false; modalSave.removeAttribute('aria-busy'); deviceNameEl.focus(); }
                    })();
                }
            }
        }

        function closeModal(){ modalBackdrop.classList.remove('open'); modalBackdrop.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; try { if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') lastFocusedEl.focus(); } catch (e) {} }

        modalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
        modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modalBackdrop.classList.contains('open')) { closeModal(); } });

        createBtn.setAttribute('aria-label','Create device'); createBtn.addEventListener('click', (e)=> { lastFocusedEl = e.currentTarget; openModal('create'); });

        let offset = 0; let limit = Number(pageSizeEl.value) || 10; let currentPage = 1; let totalCount = null;

        async function fetchDevices(){
            try{
                showLoading(); limit = Number(pageSizeEl.value) || 10; const q = encodeURIComponent(searchInput.value || ''); const url = `/v1/admin/devices?offset=${offset}&limit=${limit}` + (q ? `&search=${q}` : ''); const resp = await fetch(url, { cache: 'no-store' }); if (!resp.ok){ showToast('Failed to load devices', { type: 'error' }); return; } const data = await resp.json(); let items;
                if (Array.isArray(data)) items = data;
                else if (Array.isArray(data.Devices)) items = data.Devices;
                else if (Array.isArray(data.devices)) items = data.devices;
                else items = [];
                if (typeof data.Total === 'number') totalCount = data.Total; else if (typeof data.total === 'number') totalCount = data.total; else totalCount = null;
                renderDevices(items);
            } catch (e){ console.error('fetchDevices error', e); showToast('Failed to load devices', { type: 'error' }); }
            finally{ hideLoading(); }
        }

        function renderDevices(items){
            devicesTableBody.innerHTML = '';
            if (!items || items.length === 0){ const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = 4; td.style.color = '#9aa4b2'; td.innerText = 'No devices'; tr.appendChild(td); devicesTableBody.appendChild(tr); return; }

            items.forEach(d => {
                const tr = document.createElement('tr');
                // Device cell: show device name and under it the assigned admins as tags
                const nameTd = document.createElement('td');
                const nameWrap = document.createElement('div');
                const title = document.createElement('div'); title.style.fontWeight = '700'; title.style.marginBottom = '6px'; title.innerText = d.DeviceName ?? d.deviceName ?? d.Name ?? d.name ?? '';
                const adminsWrapper = document.createElement('div'); adminsWrapper.style.display = 'flex'; adminsWrapper.style.flexWrap = 'wrap'; adminsWrapper.style.gap = '8px';
                const admins = d.AssignedAdmins ?? d.Admins ?? d.AdminIds ?? d.admins ?? [];
                if (Array.isArray(admins) && admins.length){
                    admins.forEach(a => {
                        const badge = document.createElement('span'); badge.className = 'admin-badge'; const email = a.Email ?? a.email ?? a.EmailAddress ?? String(a.UserId ?? a.userId ?? a.id ?? ''); badge.innerText = email; adminsWrapper.appendChild(badge);
                    });
                } else {
                    const span = document.createElement('div'); span.style.color = '#9aa4b2'; span.innerText = 'No assigned admins'; adminsWrapper.appendChild(span);
                }
                nameWrap.appendChild(title); nameWrap.appendChild(adminsWrapper); nameTd.appendChild(nameWrap);

                const imeiTd = document.createElement('td'); imeiTd.innerText = d.IMEI ?? d.Imei ?? d.imei ?? '';
                // Keep the Assigned Admins column for backward compatibility but show a count there
                const assignedCountTd = document.createElement('td'); assignedCountTd.style.color = '#9aa4b2'; assignedCountTd.innerText = Array.isArray(admins) ? String(admins.length) : '0';
                const actionsTd = document.createElement('td'); actionsTd.style.display='flex'; actionsTd.style.gap='8px';
                const edit = document.createElement('button'); edit.className='btn-ghost'; edit.innerText='Edit'; edit.addEventListener('click', (e)=>{ lastFocusedEl = e.currentTarget; openModal('edit', d); });
                const assignBtn = document.createElement('button'); assignBtn.className='btn-ghost'; assignBtn.innerText='Assignments'; assignBtn.addEventListener('click', (e)=>{ lastFocusedEl = e.currentTarget; openAssignmentsModal(d); });
                const del = document.createElement('button'); del.className='btn-danger'; del.innerText='Delete'; del.addEventListener('click', (e)=> deleteDevice(d, e.currentTarget));
                actionsTd.appendChild(edit); actionsTd.appendChild(assignBtn); actionsTd.appendChild(del);

                tr.appendChild(nameTd); tr.appendChild(imeiTd); tr.appendChild(assignedCountTd); tr.appendChild(actionsTd);
                devicesTableBody.appendChild(tr);
            });

            const page = Math.floor(offset / limit) + 1; currentPage = page; currentPageEl.innerText = String(page);
            prevPageBtn.disabled = offset === 0;
            if (totalCount !== null) nextPageBtn.disabled = offset + limit >= totalCount; else nextPageBtn.disabled = items.length < limit;
        }

        prevPageBtn.addEventListener('click', ()=>{ if (offset === 0) return; offset = Math.max(0, offset - limit); fetchDevices(); });
        nextPageBtn.addEventListener('click', ()=>{ offset += limit; fetchDevices(); });

        pageSizeEl.addEventListener('change', ()=>{ offset = 0; fetchDevices(); });

        // custom page size visual
        if (pageSizeWrap){
            pageSizeWrap.addEventListener('click', (e)=>{ e.stopPropagation(); const isOpen = pageSizeOptions.classList.toggle('open'); pageSizeWrap.setAttribute('aria-expanded', String(isOpen)); });
            pageSizeWrap.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); const isOpen = pageSizeOptions.classList.toggle('open'); pageSizeWrap.setAttribute('aria-expanded', String(isOpen)); } if (e.key === 'ArrowDown'){ e.preventDefault(); pageOptionButtons[0] && pageOptionButtons[0].focus(); } });
        }
        pageOptionButtons.forEach(btn => { btn.addEventListener('click', ()=>{ const v = btn.getAttribute('data-value'); if (v){ pageSizeEl.value = v; pageSizeDisplay.innerText = v; } pageSizeOptions.classList.remove('open'); pageSizeWrap.setAttribute('aria-expanded','false'); offset = 0; fetchDevices(); }); });

        // debounce search
        const debouncedFetch = debounce(()=>{ offset = 0; fetchDevices(); }, 300);
        searchInput.addEventListener('input', debouncedFetch);
        searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); offset = 0; fetchDevices(); } });

        modalSave.addEventListener('click', async (e)=>{
            e.preventDefault(); const id = deviceIdEl.value && deviceIdEl.value.trim(); const payload = { DeviceId: id || undefined, DeviceName: deviceNameEl.value.trim(), IMEI: imeiEl.value.trim(), AdminIds: assignedAdmins.map(a => a.UserId ?? a.userId ?? a.id) };
            try{
                if (!payload.DeviceName){ showToast('Device name is required', { type:'error' }); deviceNameEl.focus(); return; }
                modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');
                if (!id){
                    const resp = await fetch('/v1/admin/devices', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (resp.ok){ showToast('Device created'); closeModal(); fetchDevices(); }
                    else { const bt = await resp.text().catch(()=>null); showToast('Create failed: ' + (bt || resp.status), { type:'error' }); }
                } else {
                    const url = `/v1/admin/devices/${encodeURIComponent(id)}`;
                    const resp = await fetch(url, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (resp.ok){ showToast('Device updated'); closeModal(); fetchDevices(); }
                    else { const bt = await resp.text().catch(()=>null); showToast('Update failed: ' + (bt || resp.status), { type:'error' }); }
                }
            } catch (e){ console.error(e); showToast('Save failed', { type:'error' }); }
            finally{ modalSave.disabled = false; modalSave.removeAttribute('aria-busy'); }
        });

        async function deleteDevice(d, btn){
            const id = d.DeviceId ?? d.deviceId ?? d.id ?? d.Id ?? null;
            if (!id){ showToast('Cannot determine device id', {type:'error'}); return; }
            if (!confirm('Delete device ' + (d.DeviceName ?? d.deviceName ?? d.Name ?? d.name ?? id) + '? This action cannot be undone.')) return;
            try{
                if (btn) btn.disabled = true; const url = `/v1/admin/devices/${encodeURIComponent(id)}`; const resp = await fetch(url, { method: 'DELETE' }); if (resp.ok){ showToast('Device deleted'); fetchDevices(); } else { const bt = await resp.text().catch(()=>null); showToast('Delete failed: ' + (bt || resp.status), { type:'error' }); }
            } catch (e){ console.error(e); showToast('Delete failed', { type:'error' }); }
            finally{ if (btn) btn.disabled = false; }
        }

        // init
        updatePageSizeDisplay = function(){ try { pageSizeDisplay.innerText = pageSizeEl.value || '10'; } catch (e) {} };
        updatePageSizeDisplay();

        // Close custom page options on outside click
        document.addEventListener('click', (e)=>{ if (!pageSizeWrap.contains(e.target)) pageSizeOptions.classList.remove('open'); });

        // --- Assignments modal markup and logic ---
        // create modal DOM nodes for assignments (inserted into document.body)
        const assignModalHtml = `
        <div id="assignModalBackdrop" class="modal-backdrop" aria-hidden="true">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="assignModalTitle">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div id="assignModalTitle" style="font-weight:700;font-size:16px;color:#e6eef8">Manage Assignments</div>
                        <div id="assignModalSub" style="color:#9aa4b2;font-size:13px">Assign or remove admins for the device</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button id="assignModalCancel" class="btn-ghost">Close</button>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <input type="hidden" id="assignDeviceId" />
                    <div style="font-weight:600;color:#e6eef8;margin-bottom:8px;" id="assignDeviceName"></div>
                    <div style="margin-bottom:8px;">
                        <label style="color:#9aa4b2;font-size:13px;display:block;margin-bottom:6px;">Assigned admins</label>
                        <div id="assignAssignedAdmins" style="display:flex;flex-wrap:wrap;gap:8px"></div>
                    </div>
                    <div>
                        <label style="color:#9aa4b2;font-size:13px;display:block;margin-bottom:6px;">Add admin</label>
                        <input id="assignAdminSearch" class="search" placeholder="Search admins by email" />
                        <div id="assignAdminResults" class="admin-search-results" style="display:none;margin-top:8px;"></div>
                    </div>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', assignModalHtml);

        const assignModalBackdrop = document.getElementById('assignModalBackdrop');
        const assignModalCancel = document.getElementById('assignModalCancel');
        const assignDeviceIdEl = document.getElementById('assignDeviceId');
        const assignDeviceNameEl = document.getElementById('assignDeviceName');
        const assignAssignedAdminsRoot = document.getElementById('assignAssignedAdmins');
        const assignAdminSearchEl = document.getElementById('assignAdminSearch');
        const assignAdminResultsEl = document.getElementById('assignAdminResults');

        let currentAssignDeviceId = null;
        let currentAssignAdmins = []; // array of { UserId, Email, DeviceAssignmentId? }

        function renderAssignAssignedAdmins(){
            assignAssignedAdminsRoot.innerHTML = '';
            if (!currentAssignAdmins || currentAssignAdmins.length === 0){ const s = document.createElement('div'); s.style.color='#9aa4b2'; s.innerText = 'No assigned admins'; assignAssignedAdminsRoot.appendChild(s); return; }
            currentAssignAdmins.forEach(a => {
                const wrap = document.createElement('div'); wrap.className = 'admin-badge'; wrap.style.display='inline-flex'; const txt = document.createElement('span'); txt.innerText = a.Email ?? String(a.UserId ?? a.userId ?? a.id ?? ''); const btn = document.createElement('button'); btn.type='button'; btn.className='admin-remove'; btn.innerText='✕'; btn.addEventListener('click', async ()=>{
                    // attempt to delete the assignment by DeviceAssignmentId if present, otherwise ask server to remove by user id
                    if (!currentAssignDeviceId) return;
                    if (!confirm('Unassign admin ' + (a.Email ?? a.UserId) + '?')) return;
                    try{
                        if (a.DeviceAssignmentId){
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments/${encodeURIComponent(a.DeviceAssignmentId)}`, { method: 'DELETE' });
                            if (!resp.ok) { const txt = await resp.text().catch(()=>null); showToast('Unassign failed: '+(txt||resp.status), { type:'error' }); return; }
                        } else {
                            // fallback: try delete endpoint with user id in path (not defined) - instead request server to delete by searching assignments list
                            // We'll fetch assignments and find matching DeviceAssignmentId then delete
                            const assignments = await fetchAssignmentsForDevice(currentAssignDeviceId);
                            const match = assignments.find(x => (x.UserId == (a.UserId ?? a.userId ?? a.id)));
                            if (match && match.DeviceAssignmentId){ const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments/${encodeURIComponent(match.DeviceAssignmentId)}`, { method: 'DELETE' }); if (!resp.ok){ const txt = await resp.text().catch(()=>null); showToast('Unassign failed: '+(txt||resp.status), { type:'error' }); return; } }
                            else { showToast('Could not determine assignment id to delete', { type:'error' }); return; }
                        }
                        showToast('Admin unassigned');
                        await loadAssignmentsForModal(currentAssignDeviceId);
                        fetchDevices();
                    } catch (e){ console.error(e); showToast('Unassign failed', { type:'error' }); }
                });
                wrap.appendChild(txt); wrap.appendChild(btn); assignAssignedAdminsRoot.appendChild(wrap);
            });
        }

        async function fetchAssignmentsForDevice(deviceId){
            try{
                const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(deviceId)}/assignments?offset=0&limit=100`, { cache: 'no-store' });
                if (!resp.ok) return [];
                const data = await resp.json();
                if (Array.isArray(data)) return data; if (Array.isArray(data.DeviceAssignments)) return data.DeviceAssignments; if (Array.isArray(data.deviceAssignments)) return data.deviceAssignments; return [];
            } catch (e){ console.warn('fetchAssignmentsForDevice', e); return []; }
        }

        async function loadAssignmentsForModal(deviceId){
            currentAssignAdmins = [];
            try{
                // prefer device details with assigned admin emails
                const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(deviceId)}`, { cache: 'no-store' });
                if (resp.ok){ const dd = await resp.json(); const dev = Array.isArray(dd) ? dd[0] : dd; const adminsSrc = dev.AssignedAdmins ?? dev.Admins ?? dev.AdminIds ?? dev.admins ?? [];
                    if (Array.isArray(adminsSrc) && adminsSrc.length){
                        currentAssignAdmins = adminsSrc.map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a.UserId ?? a, Email: a.Email ?? a.email ?? String(a.UserId ?? a.userId ?? a.id ?? '') , DeviceAssignmentId: a.DeviceAssignmentId ?? a.deviceAssignmentId ?? a.DeviceAssignmentId }));
                    } else {
                        // try assignments endpoint and then attempt to resolve user emails (best-effort)
                        const assignments = await fetchAssignmentsForDevice(deviceId);
                        currentAssignAdmins = assignments.map(a => ({ UserId: a.UserId ?? a.userId ?? a.UserId, DeviceAssignmentId: a.DeviceAssignmentId ?? a.deviceAssignmentId ?? a.Id }));
                        // try to fetch user emails for these ids via admin search endpoint by id (best-effort skipped here)
                    }
                } else {
                    const assignments = await fetchAssignmentsForDevice(deviceId);
                    currentAssignAdmins = assignments.map(a => ({ UserId: a.UserId ?? a.userId ?? a.UserId, DeviceAssignmentId: a.DeviceAssignmentId ?? a.deviceAssignmentId ?? a.Id }));
                }
            } catch (e){ console.warn('loadAssignmentsForModal', e); }
            renderAssignAssignedAdmins();
        }

        function openAssignmentsModal(device){
            try { lastFocusedEl = document.activeElement; } catch (e){}
            assignModalBackdrop.classList.add('open'); assignModalBackdrop.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
            const id = device.DeviceId ?? device.deviceId ?? device.id ?? device.Id ?? null;
            currentAssignDeviceId = id;
            assignDeviceIdEl.value = id || '';
            assignDeviceNameEl.innerText = device.DeviceName ?? device.deviceName ?? device.Name ?? device.name ?? '';
            loadAssignmentsForModal(id);
            assignAdminSearchEl.focus();
        }

        function closeAssignmentsModal(){ assignModalBackdrop.classList.remove('open'); assignModalBackdrop.setAttribute('aria-hidden','true'); document.body.style.overflow=''; try{ if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') lastFocusedEl.focus(); }catch(e){} }

        assignModalCancel.addEventListener('click', ()=> closeAssignmentsModal());
        assignModalBackdrop.addEventListener('click', (e)=>{ if (e.target === assignModalBackdrop) closeAssignmentsModal(); });

        // search / add admin inside assignments modal (reuse fetchAdmins)
        let assignSearchToken = 0;
        const doAssignAdminSearch = debounce(async ()=>{
            const q = (assignAdminSearchEl.value || '').trim(); assignAdminResultsEl.innerHTML = '';
            if (!q){ assignAdminResultsEl.style.display='none'; return; }
            assignAdminResultsEl.style.display='';
            const token = ++assignSearchToken; const results = await fetchAdmins(q); if (token !== assignSearchToken) return;
            if (!results || results.length === 0){ assignAdminResultsEl.innerHTML = '<div class="admin-result" style="justify-content:center;color:#9aa4b2">No admins</div>'; return; }
            results.forEach(r => {
                const id = r.UserId ?? r.userId ?? r.id ?? r.Id ?? null; const email = r.Email ?? r.email ?? r.EmailAddress ?? String(id ?? '');
                const row = document.createElement('div'); row.className = 'admin-result'; const left = document.createElement('div'); left.style.overflow='hidden'; left.style.textOverflow='ellipsis'; left.style.whiteSpace='nowrap'; left.style.flex='1'; left.innerText = email; const btn = document.createElement('button'); btn.type='button'; btn.className='btn-ghost'; btn.innerText='Add'; btn.addEventListener('click', async ()=>{
                    if (!currentAssignDeviceId) return; const exists = currentAssignAdmins.some(x => (x.UserId == id)); if (exists){ showToast('Admin already assigned'); return; }
                    try{
                        const payload = { UserId: id, DeviceId: currentAssignDeviceId };
                        const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        if (resp.ok){ showToast('Admin assigned'); await loadAssignmentsForModal(currentAssignDeviceId); fetchDevices(); }
                        else { const txt = await resp.text().catch(()=>null); showToast('Assign failed: '+(txt||resp.status), { type:'error' }); }
                    } catch (e){ console.error(e); showToast('Assign failed', { type:'error' }); }
                });
                row.appendChild(left); row.appendChild(btn); assignAdminResultsEl.appendChild(row);
            });
        }, 300);

        assignAdminSearchEl.addEventListener('input', doAssignAdminSearch);
        assignAdminSearchEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); doAssignAdminSearch(); } });

        // close assign modal when pressing Escape
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && assignModalBackdrop.classList.contains('open')) closeAssignmentsModal(); });

        // init
        updatePageSizeDisplay = function(){ try { pageSizeDisplay.innerText = pageSizeEl.value || '10'; } catch (e) {} };
        updatePageSizeDisplay();

        // Close custom page options on outside click
        document.addEventListener('click', (e)=>{ if (!pageSizeWrap.contains(e.target)) pageSizeOptions.classList.remove('open'); });

        fetchDevices();
    })();
    </script>
</body>
</html>

