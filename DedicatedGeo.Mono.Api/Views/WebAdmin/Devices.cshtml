@{
    Layout = null; // standalone admin devices page styled like Users.cshtml
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Devices Management</title>

    <style>
        /* Reuse styling approach from Users.cshtml to keep visual consistency */
        html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, rgba(3,7,12,1), rgba(6,10,16,1)); color: #e6eef8; }

        .root{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:32px; box-sizing:border-box; }

        .card{
            width: min(960px, 96vw);
            margin-top:32px;
            background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98));
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(2,6,23,0.6);
            display:flex; flex-direction:column; gap:16px;
        }

        .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .card-header h1{ margin:0; font-size:18px; }
        .card-sub{ color:#9aa4b2; font-size:13px; }

        .controls{ display:flex; gap:8px; align-items:center; }
        .search{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:#e6eef8; }

        table.devices{ width:100%; border-collapse:collapse; font-size:14px; }
        table.devices thead th{ text-align:left; color:#9aa4b2; font-weight:600; padding:10px; font-size:13px; }
        table.devices tbody td{ padding:10px; border-top:1px solid rgba(255,255,255,0.02); }
        table.devices tbody tr:hover td{ background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }

        .btn-primary{
            background: linear-gradient(90deg, #7c5cff, #5ab3ff);
            border:none; color:white; padding:10px 14px; font-weight:700; border-radius:10px; cursor:pointer; font-size:14px;
            box-shadow: 0 8px 30px rgba(90,179,255,0.06);
        }
        .btn-ghost{
            background: transparent; border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600;
        }
        .btn-danger{ background: linear-gradient(180deg,#ef4444,#c81b1b); color:white; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }

        .pagination{ display:flex; gap:8px; align-items:center; }
        .page-input{ -webkit-appearance: none; -moz-appearance: none; appearance: none; padding:6px 36px 6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background-image: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)), linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.25) 50%), linear-gradient(135deg, rgba(255,255,255,0.25) 50%, transparent 50%); background-position: left top, calc(100% - 16px) calc(1em + 2px), calc(100% - 12px) calc(1em + 2px); background-size: auto, .5em .5em, .5em .5em; background-repeat: no-repeat; background-color: transparent; color:#e6eef8; cursor:pointer; box-sizing:border-box; }
        .page-input::-ms-expand{ display:none; }
        .page-input:focus{ outline:2px solid rgba(90,179,255,0.12); box-shadow: 0 6px 18px rgba(90,179,255,0.04); }
        .page-input option{ background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); color:#eeefef; padding:6px 8px; }

        /* Custom page-size selector visuals (copied from Users.cshtml) */
        .page-select-wrap{ position:relative; display:flex; align-items:center; gap:8px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; cursor:pointer; min-width:90px; box-sizing:border-box; }
        .page-select-value{ color:#e6eef8; font-weight:600; }
        .page-select-value::after{ content: ''; display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:7px solid rgba(255,255,255,0.7); margin-left:8px; transform:translateY(1px); }
        .page-options{ position:absolute; top:calc(100% + 8px); left:0; min-width:100%; background:linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:8px; display:none; z-index:1500; box-shadow:0 18px 60px rgba(2,6,23,0.6); box-sizing:border-box; }
        .page-options.open{ display:block; }
        .page-option{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:6px 8px; border-radius:8px; cursor:pointer; color:#e6eef8; }
        .page-option:hover{ background: rgba(255,255,255,0.02); }
        .page-option:focus{ outline:2px solid rgba(90,179,255,0.12); }

        .modal-backdrop{ position:fixed; inset:0; background: rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:1400; }
        .modal-backdrop.open{ display:flex; }
        .modal-card{ width: min(700px, 96vw); background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:16px; border-radius:12px; box-shadow: 0 24px 80px rgba(2,6,23,0.6); }
        .form-row{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
        label{ color:#9aa4b2; font-size:13px; }
        input[type="text"], input[type="email"], input[type="password"], select{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border: 1px solid rgba(255,255,255,0.04); color: #e6eef8; padding: 10px 12px; border-radius: 10px; outline:none; }
        .row{ display:flex; gap:8px; align-items:center; }

        .toast-container{ position: fixed; top: 16px; right: 16px; z-index: 1600; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
        .toast{ min-width: 220px; max-width: 88vw; background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98)); color: #e6eef8; border: 1px solid rgba(255,255,255,0.04); padding: 10px 12px; border-radius: 10px; box-shadow: 0 12px 36px rgba(2,6,23,0.6); font-size:13px; display:flex; align-items:center; gap:10px; }
        .toast.error{ border-color: rgba(239,68,68,0.18); background: linear-gradient(180deg, rgba(239,68,68,0.06), rgba(11,18,28,0.95)); color:#fff2f2; }

        .spinner{ width:28px; height:28px; border-radius:999px; border:3px solid rgba(255,255,255,0.06); border-top-color:#5ab3ff; animation:spin 1s linear infinite; }
        @@keyframes spin{ to { transform:rotate(360deg); } }

        /* assigned admin badges */
        .admin-badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: linear-gradient(90deg,#5ab3ff,#2db5ff); color:#012; font-weight:700; font-size:13px; }
        .admin-remove{ background:transparent; border:none; color:#012; font-weight:800; cursor:pointer; }

        .admin-assign-list{ display:flex; flex-wrap:wrap; gap:8px; }
        .admin-search-results{ max-height:240px; overflow:auto; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); padding:8px; }
        .admin-result{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer; }
        .admin-result:hover{ background: rgba(255,255,255,0.02); }

        /* Map-style selector (cds-*) minimal styles reused for Assignments modal */
        .custom-device-select{ position: relative; width:100%; box-sizing: border-box; }
        .cds-toggle{ box-sizing: border-box; }
        /* force full-width in stubborn layouts */
        .custom-device-select, .cds-toggle { width:100% !important; }
        /* Custom device dropdown styling copied from Map view to match sidebar language */
        .cds-toggle{
            display:flex; align-items:center; justify-content:space-between; gap:12px; width:100% !important;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
            border: 1px solid rgba(255,255,255,0.04);
            padding: 8px 12px; border-radius: 10px; color: #e6eef8; cursor: pointer; font-size:13px;
        }
        .cds-toggle .label{ width:100%; }
        .cds-toggle .label{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#e6eef8; font-weight:600; }
        .cds-right{ margin-left:auto; display:flex; align-items:center; gap:8px; }
        .cds-caret{ width:18px; height:18px; display:flex; align-items:center; justify-content:center; transform:rotate(0deg); transition:transform .18s ease; opacity:0.95 }
        .cds-open .cds-caret{ transform: rotate(180deg); }
        .cds-caret svg{ width:12px; height:12px; fill: #9aa4b2; }

        .cds-list{
            position:absolute; right:0; left:0; top:calc(100% + 8px);
            /* fully opaque background to match sidebar surface and avoid translucency */
            background: #0b121c;
            border:1px solid rgba(255,255,255,0.04); border-radius:12px; padding:8px; z-index:1300;
            max-height:320px; overflow-y:auto; overflow-x:hidden; box-shadow: 0 16px 48px rgba(2,6,23,0.7);
            box-sizing: border-box;
        }
        /* ensure the search input fits exactly inside the dropdown (avoid horizontal overflow) */
        .cds-search{ display:block; width:100%; box-sizing:border-box; padding:8px 10px; margin-bottom:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background: #0b121c; color:#e6eef8; }
        /* ensure items container doesn't cause horizontal overflow */
        .cds-list .cds-items{ width:100%; box-sizing:border-box; overflow-x:hidden; }
         .cds-empty{ padding:8px; color:#9aa4b2; text-align:center; }
         .cds-item{ padding:10px; border-radius:8px; color:#e6eef8; display:flex; align-items:center; gap:12px; cursor:pointer; }
         .cds-item:hover{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); }
        .cds-item.selected{ background: linear-gradient(180deg, rgba(90,179,255,0.08), rgba(90,179,255,0.02)); border:1px solid rgba(90,179,255,0.12); }
        .cds-item .name{ font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .cds-item .id{ color:#9aa4b2; font-size:12px; margin-left:auto; }

        /* Unified, pretty scrollbars for supported browsers (copied from Map.css) */
        :root{
            --scrollbar-thumb: rgba(255,255,255,0.04);
            --scrollbar-thumb-hover: rgba(255,255,255,0.08);
            --scrollbar-track: transparent;
            --scrollbar-width: 10px;
        }
        .cds-list, .modal-card, .cds-list .cds-items {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.04) transparent;
        }
        .cds-list::-webkit-scrollbar, .modal-card::-webkit-scrollbar, .cds-list .cds-items::-webkit-scrollbar { width: 10px; height: 10px; }
        .cds-list::-webkit-scrollbar-track, .modal-card::-webkit-scrollbar-track, .cds-list .cds-items::-webkit-scrollbar-track { background: transparent; }
        .cds-list::-webkit-scrollbar-thumb, .modal-card::-webkit-scrollbar-thumb, .cds-list .cds-items::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.04); border-radius: 8px; border: 2px solid rgba(255,255,255,0.01); }
        .cds-list:hover::-webkit-scrollbar-thumb, .modal-card:hover::-webkit-scrollbar-thumb, .cds-list .cds-items:hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); }
        .cds-list:focus-visible::-webkit-scrollbar-thumb, .modal-card:focus-visible::-webkit-scrollbar-thumb, .cds-list .cds-items:focus-visible::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); outline: 2px solid rgba(90,179,255,0.08); }

        /* Admin button style (matches Map view picker's visual language) */
        #adminButtons{ display:flex; gap:8px; align-items:center; }
        #adminButtons .admin-btn{
            display:inline-flex; align-items:center; justify-content:center; gap:8px;
            background: rgba(11,18,28,0.85);
            color: #e6eef8; text-decoration:none; border:1px solid rgba(255,255,255,0.04);
            padding:8px 12px; min-height:36px; border-radius:8px; font-weight:600; font-size:13px;
            box-sizing:border-box; cursor:pointer;
        }
        #adminButtons .admin-btn:hover{ filter:brightness(1.06); }

        @@media (max-width:720px){ .card{ width:94vw; margin-top:18px; } table.devices thead{ display:none; } table.devices tbody td{ display:block; width:100%; } }
    </style>
</head>
<body>
    <main class="root" role="main">
        <section class="card" aria-labelledby="devicesTitle">
            <div class="card-header">
                <div>
                    <h1 id="devicesTitle">Device Management</h1>
                    <div class="card-sub">Create, edit, assign users and delete devices.</div>
                </div>

                @{ 
                    // Read role(s) from the ticket/claims using the explicit claim type provided by the user.
                    var claimType = "http://schemas.microsoft.com/ws/2008/06/identity/claims/role";
                    var isSuper = false;
                    var isAdmin = false;
                    if (User != null)
                    {
                        foreach (var c in User.Claims)
                        {
                            if (c == null) continue;
                            if (!string.Equals(c.Type, claimType, System.StringComparison.OrdinalIgnoreCase)) continue;
                            var v = (c.Value ?? string.Empty).Trim();
                            if (string.Equals(v, "SuperAdmin", System.StringComparison.OrdinalIgnoreCase)) { isSuper = true; isAdmin = true; break; }
                            if (string.Equals(v, "Admin", System.StringComparison.OrdinalIgnoreCase)) { isAdmin = true; }
                        }
                    }
                }

                <div id="adminButtons" style="margin-right:12px;">
                    <a href="/map" class="admin-btn">Map</a>
                    @if (isAdmin) {
                        <a href="/admin/devices" class="admin-btn">Devices</a>
                    }
                    @if (isSuper) {
                        <a href="/admin/users" class="admin-btn">Users</a>
                    }
                </div>

                <div class="controls">
                    <input id="searchInput" class="search" placeholder="Filter by name or IMEI" />
                    <button id="createBtn" class="btn-primary">Create device</button>
                </div>
            </div>

            <div id="tableWrapper" style="position:relative;overflow:auto;">
                <div id="tableSpinner" class="spinner" aria-hidden="true" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);"></div>
                <table class="devices" id="devicesTable" aria-describedby="devicesTitle" aria-busy="false">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>IMEI</th>
                            <th style="width:200px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- populated by JS -->
                    </tbody>
                </table>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                <div class="pagination">
                    <button id="prevPage" class="btn-ghost">Previous</button>
                    <div style="display:flex;align-items:center;gap:8px;color:#9aa4b2">
                        Page <span id="currentPage">1</span>
                    </div>
                    <button id="nextPage" class="btn-ghost">Next</button>
                </div>

                <div style="display:flex;align-items:center;gap:8px;">
                    <label id="pageSizeLabel" style="color:#9aa4b2;font-size:13px;">Page size</label>
                    <select id="pageSize" class="page-input" aria-hidden="true" style="display:none;">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>

                    <div class="page-select-wrap" id="pageSizeWrap" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="pageSizeLabel">
                        <div class="page-select-value" id="pageSizeDisplay">10</div>
                        <div class="page-options" id="pageSizeOptions" role="listbox" tabindex="-1">
                            <button type="button" class="page-option" data-value="10">10</button>
                            <button type="button" class="page-option" data-value="25">25</button>
                            <button type="button" class="page-option" data-value="50">50</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div>
                    <div id="modalTitle" style="font-weight:700;font-size:16px;color:#e6eef8">Create device</div>
                    <div id="modalSub" style="color:#9aa4b2;font-size:13px"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button id="modalCancel" class="btn-ghost">Cancel</button>
                    <button id="modalSave" type="button" class="btn-primary">Save</button>
                </div>
            </div>

            <form id="deviceForm" style="margin-top:12px;">
                <input type="hidden" id="deviceId" />
                <div class="form-row">
                    <label for="deviceName">Device name</label>
                    <input id="deviceName" type="text" required />
                </div>
                <div class="form-row">
                    <label for="imei">IMEI</label>
                    <input id="imei" type="text" />
                </div>

                <!-- Removed device modal inline admin assignment UI: assignments are managed in the Assignments modal -->
                </form>
        </div>
    </div>

    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
    (function(){
        function debounce(fn, wait){ let t = null; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); }; }

        const tableSpinner = document.getElementById('tableSpinner');
        function showLoading(){ if (tableSpinner) tableSpinner.style.display = ''; document.getElementById('devicesTable').setAttribute('aria-busy','true'); prevPageBtn.disabled = true; nextPageBtn.disabled = true; }
        function hideLoading(){ if (tableSpinner) tableSpinner.style.display = 'none'; document.getElementById('devicesTable').setAttribute('aria-busy','false'); }

        let lastFocusedEl = null;

        const devicesTableBody = document.querySelector('#devicesTable tbody');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const currentPageEl = document.getElementById('currentPage');
        const pageSizeEl = document.getElementById('pageSize');
        const searchInput = document.getElementById('searchInput');

        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalSave = document.getElementById('modalSave');
        const modalCancel = document.getElementById('modalCancel');
        const deviceIdEl = document.getElementById('deviceId');
        const deviceNameEl = document.getElementById('deviceName');
        const imeiEl = document.getElementById('imei');

        const createBtn = document.getElementById('createBtn');
        const toastContainer = document.getElementById('toastContainer');

        // Admin assignment UI
        // const assignedAdminsRoot = document.getElementById('assignedAdmins');
        // const adminSearchEl = document.getElementById('adminSearch');
        // const adminResultsEl = document.getElementById('adminResults');

        // let assignedAdmins = []; // array of { UserId, Email }

        // page selector custom UI (simple)
        const pageSizeWrap = document.getElementById('pageSizeWrap');
        const pageSizeOptions = document.getElementById('pageSizeOptions');
        const pageSizeDisplay = document.getElementById('pageSizeDisplay');
        const pageOptionButtons = Array.from(document.querySelectorAll('.page-option'));

        function showToast(message, { type = 'default', duration = 4000 } = {}){
            const t = document.createElement('div');
            t.className = 'toast' + (type === 'error' ? ' error' : '');
            t.setAttribute('role','status');
            t.textContent = message;
            const close = document.createElement('button'); close.type = 'button'; close.innerText = 'Close'; close.className = 'btn-ghost'; close.style.marginLeft = '8px';
            close.addEventListener('click', () => t.remove());
            t.appendChild(close);
            toastContainer.appendChild(t);
            if (duration > 0) setTimeout(() =>{ try{ t.remove(); }catch(e){} }, duration);
        }

        // Admin search
        async function fetchAdmins(q){
            try{
                const searchParam = q ? `&search=${encodeURIComponent(q)}` : '';
                const searchParam1 = q ? `&role=DeviceUser` : '';
                // try server paged endpoint similar to users list
                const url = `/v1/admin/users?offset=0&limit=50${searchParam}${searchParam1}`;
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) return [];
                const data = await resp.json();
                if (Array.isArray(data)) return data;
                if (Array.isArray(data.Users)) return data.Users;
                if (Array.isArray(data.users)) return data.users;
                return [];
            } catch (e){ console.warn('fetchAdmins error', e); return []; }
        }

        // Modal open/close
        function openModal(mode, device){
            try { lastFocusedEl = document.activeElement; } catch (e) {}
            modalBackdrop.classList.add('open'); modalBackdrop.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
            if (mode === 'create'){
                modalTitle.innerText = 'Create device'; deviceIdEl.value = ''; deviceNameEl.value = ''; imeiEl.value = ''; 
            } else {
                modalTitle.innerText = 'Edit device';
                const id = device.DeviceId ?? device.deviceId ?? device.id ?? device.Id ?? null;
                if (!id){ deviceIdEl.value = device.DeviceId ?? device.deviceId ?? device.id ?? ''; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? '';  }
                else {
                    // fetch the single device for freshest data
                    (async ()=>{
                        modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');
                        try{
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(id)}`, { cache: 'no-store' });
                            if (resp.ok){ const data = await resp.json(); const d = Array.isArray(data) ? data[0] : data; deviceIdEl.value = d.DeviceId ?? d.deviceId ?? d.id ?? id; deviceNameEl.value = d.DeviceName ?? d.deviceName ?? d.name ?? ''; imeiEl.value = d.IMEI ?? d.Imei ?? d.imei ?? ''; }
                            else { showToast('Failed to load device details; using provided values', { type: 'error' }); deviceIdEl.value = id; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? ''; }
                        } catch (e){ console.warn('openModal fetch device', e); deviceIdEl.value = id; deviceNameEl.value = device.DeviceName ?? device.deviceName ?? device.name ?? ''; imeiEl.value = device.IMEI ?? device.Imei ?? device.imei ?? ''; }
                        finally{ modalSave.disabled = false; modalSave.removeAttribute('aria-busy');  }
                    })();
                }
            }
        }

        function closeModal(){ modalBackdrop.classList.remove('open'); modalBackdrop.setAttribute('aria-hidden','true'); document.body.style.overflow = '';  }

        modalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
        modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modalBackdrop.classList.contains('open')) { closeModal(); } });

        createBtn.setAttribute('aria-label','Create device'); createBtn.addEventListener('click', (e)=> { lastFocusedEl = e.currentTarget; openModal('create'); });

        // Save handler for create/edit device modal
        // central save routine - used by both the Save button and the form submit
        async function saveDevice(e){
            try{ if (e && typeof e.preventDefault === 'function') e.preventDefault(); } catch(e){}
            const id = (deviceIdEl && deviceIdEl.value) ? deviceIdEl.value.trim() : '';
            const payload = { DeviceId: id || undefined, DeviceName: deviceNameEl.value.trim(), IMEI: imeiEl.value.trim() };
            if (!payload.DeviceName){ showToast('Device name is required', { type:'error' });  return; }
            try{
                modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');
                if (!id){
                    const resp = await fetch('/v1/admin/devices', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (resp.ok){ showToast('Device created'); closeModal(); fetchDevices(); }
                    else { const bt = await resp.text().catch(()=>null); showToast('Create failed: ' + (bt || resp.status), { type:'error' }); }
                } else {
                    const url = `/v1/admin/devices/${encodeURIComponent(id)}`;
                    const resp = await fetch(url, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (resp.ok){ showToast('Device updated'); closeModal(); fetchDevices(); }
                    else { const bt = await resp.text().catch(()=>null); showToast('Update failed: ' + (bt || resp.status), { type:'error' }); }
                }
            } catch (err){ console.error('saveDevice error', err); showToast('Save failed', { type:'error' }); }
            finally{ try{ modalSave.disabled = false; modalSave.removeAttribute('aria-busy'); }catch(e){} }
        }

        // wire the named handler to both the button click and the form submit (Enter key)
        try { if (modalSave) modalSave.addEventListener('click', saveDevice); } catch(e){}
        try { const deviceForm = document.getElementById('deviceForm'); if (deviceForm) deviceForm.addEventListener('submit', saveDevice); } catch(e){}

        // Add missing deleteDevice implementation and wire the main search input.
        // This fixes: the Delete button had no handler function defined, and the search input was not wired to fetchDevices.
        // Note: per requirement we do NOT use .focus() anywhere.

        async function deleteDevice(device, btn){
            if (!device) return;
            const id = device.DeviceId ?? device.deviceId ?? device.id ?? device.Id ?? '';
            const name = device.DeviceName ?? device.deviceName ?? device.name ?? '';
            if (!id){ showToast('Unable to determine device id', { type: 'error' }); return; }
            // Use a simple confirmation dialog; avoid programmatic focus changes.
            if (!confirm('Delete device "' + (name || id) + '"?')) return;
            try{
                if (btn) btn.disabled = true;
                showLoading();
                const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(id)}`, { method: 'DELETE' });
                if (resp.ok){ showToast('Device deleted'); // reset to first page to avoid empty page edge-case
                    offset = 0; await fetchDevices();
                } else {
                    const txt = await resp.text().catch(()=>null);
                    showToast('Delete failed: ' + (txt || resp.status), { type: 'error' });
                }
            } catch (e){ console.error('deleteDevice error', e); showToast('Delete failed', { type: 'error' }); }
            finally{ if (btn) btn.disabled = false; hideLoading(); }
        }

        // Wire search input to call fetchDevices debounced and on Enter. Do not use .focus().
        try{
            if (searchInput){
                const debounced = debounce(()=>{ offset = 0; fetchDevices(); }, 300);
                searchInput.addEventListener('input', debounced);
                searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); offset = 0; fetchDevices(); } });
            }
        } catch(e){ console.warn('search wiring failed', e); }

        let offset = 0; let limit = Number(pageSizeEl.value) || 10; let currentPage = 1; let totalCount = null;

        async function fetchDevices(){
            try{
                showLoading(); limit = Number(pageSizeEl.value) || 10; const q = encodeURIComponent(searchInput.value || ''); const url = `/v1/admin/devices?offset=${offset}&limit=${limit}` + (q ? `&search=${q}` : ''); const resp = await fetch(url, { cache: 'no-store' }); if (!resp.ok){ showToast('Failed to load devices', { type: 'error' }); return; } const data = await resp.json(); let items;
                if (Array.isArray(data)) items = data;
                else if (Array.isArray(data.Devices)) items = data.Devices;
                else if (Array.isArray(data.devices)) items = data.devices;
                else items = [];
                if (typeof data.Total === 'number') totalCount = data.Total; else if (typeof data.total === 'number') totalCount = data.total; else totalCount = null;
                renderDevices(items);
            } catch (e){ console.error('fetchDevices error', e); showToast('Failed to load devices', { type: 'error' }); }
            finally{ hideLoading(); }
        }

        function renderDevices(items){
            devicesTableBody.innerHTML = '';
            if (!items || items.length === 0){ const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = 3; td.style.color = '#9aa4b2'; td.innerText = 'No devices'; tr.appendChild(td); devicesTableBody.appendChild(tr); return; }

            items.forEach(d => {
                const tr = document.createElement('tr');
                // Device cell: show device name and under it the assigned admins as tags
                const nameTd = document.createElement('td');
                const nameWrap = document.createElement('div');
                const title = document.createElement('div'); title.style.fontWeight = '700'; title.style.marginBottom = '6px'; title.innerText = d.DeviceName ?? d.deviceName ?? d.Name ?? d.name ?? '';
                // Do not render assigned admin lists in the table; they are shown only in modals.
                nameWrap.appendChild(title);
                nameTd.appendChild(nameWrap);

                const imeiTd = document.createElement('td'); imeiTd.innerText = d.IMEI ?? d.Imei ?? d.imei ?? '';
                const actionsTd = document.createElement('td'); actionsTd.style.display='flex'; actionsTd.style.gap='8px';
                const edit = document.createElement('button'); edit.className='btn-ghost'; edit.innerText='Edit'; edit.addEventListener('click', (e)=>{ lastFocusedEl = e.currentTarget; openModal('edit', d); });
                const assignBtn = document.createElement('button'); assignBtn.className='btn-ghost'; assignBtn.innerText='Assignments'; assignBtn.addEventListener('click', (e)=>{ lastFocusedEl = e.currentTarget; openAssignmentsModal(d); });
                const del = document.createElement('button'); del.className='btn-danger'; del.innerText='Delete'; del.addEventListener('click', (e)=> deleteDevice(d, e.currentTarget));
                actionsTd.appendChild(edit); actionsTd.appendChild(assignBtn); actionsTd.appendChild(del);

                tr.appendChild(nameTd); tr.appendChild(imeiTd); tr.appendChild(actionsTd);
                devicesTableBody.appendChild(tr);
            });

            const page = Math.floor(offset / limit) + 1; currentPage = page; currentPageEl.innerText = String(page);
            prevPageBtn.disabled = offset === 0;
            if (totalCount !== null) nextPageBtn.disabled = offset + limit >= totalCount; else nextPageBtn.disabled = items.length < limit;
        }

        prevPageBtn.addEventListener('click', ()=>{ if (offset === 0) return; offset = Math.max(0, offset - limit); fetchDevices(); });
        nextPageBtn.addEventListener('click', ()=>{ offset += limit; fetchDevices(); });

        pageSizeEl.addEventListener('change', ()=>{ offset = 0; fetchDevices(); });

        // Page size custom selector wiring (match Users.cshtml behavior)
        function updatePageSizeDisplay(){
            try { pageSizeDisplay.innerText = pageSizeEl.value || '10'; } catch (e) {}
            if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded', pageSizeOptions.classList.contains('open'));
        }

        function openPageOptions(){
            // don't open page size options while a modal is visible
            if (document.querySelector('.modal-backdrop.open')) return;
            pageSizeOptions.classList.add('open');
            if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded','true');
            try {
                // don't steal focus if a modal is currently open
            } catch (e) {}
        }
        function closePageOptions(){
            pageSizeOptions.classList.remove('open');
            if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded','false');
        }

        // initialize visual display to match the hidden select
        try { updatePageSizeDisplay(); } catch (e) {}

        if (pageSizeWrap){
            pageSizeWrap.addEventListener('click', (e)=>{ e.stopPropagation(); if (pageSizeOptions.classList.contains('open')) closePageOptions(); else openPageOptions(); });
            pageSizeWrap.addEventListener('keydown', (e)=>{
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (pageSizeOptions.classList.contains('open')) closePageOptions(); else openPageOptions(); }
                if (e.key === 'ArrowDown'){ e.preventDefault(); // only focus the first option when no modal is open
                    if (document.querySelector('.modal-backdrop.open')) return; openPageOptions(); const first = pageOptionButtons[0];  }
            });
        }

        pageOptionButtons.forEach(btn => {
            btn.addEventListener('click', ()=>{
                const v = btn.getAttribute('data-value');
                if (v){ pageSizeEl.value = v; updatePageSizeDisplay(); }
                closePageOptions();
                // reflect change
                offset = 0; fetchDevices();
            });
        });

        // close options when clicking outside
        document.addEventListener('click', (e)=>{ if (!pageSizeWrap) return; if (!pageSizeWrap.contains(e.target)) closePageOptions(); });

        // --- Assignments modal markup and logic ---
        // create modal DOM nodes for assignments (inserted into document.body)
        const assignModalHtml = `
        <div id="assignModalBackdrop" class="modal-backdrop" aria-hidden="true">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="assignModalTitle">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div id="assignModalTitle" style="font-weight:700;font-size:16px;color:#e6eef8">Manage Assignments for <span id="assignDeviceName"></span></div>
                        <div id="assignModalSub" style="color:#9aa4b2;font-size:13px">Assign or remove users for the device</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button id="assignModalCancel" class="btn-ghost">Close</button>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <input type="hidden" id="assignDeviceId" />
                    <!-- Selector replaced with Map-style custom selector (cds-toggle) but adapted for admin search -->
                    <div style="margin-bottom:10px;">
                        <label style="color:#9aa4b2;font-size:13px;display:block;margin-bottom:6px;">Add admin</label>
                        <div id="assignSelectorRoot" class="custom-device-select" style="position:relative;">
                            <div class="cds-toggle" tabindex="0" role="button" aria-haspopup="listbox">
                                <div style="display:flex;flex-direction:column;min-width:0;">
                                    <div class="label">Select admin to assign...</div>
                                    <div class="sub" style="display:none;">&nbsp;</div>
                                </div>
                                <div class="cds-right"><div class="cds-caret">
                                    <!-- caret svg to match Map selector visuals -->
                                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M7 10l5 5 5-5z"/></svg>
                                </div></div>
                            </div>
                            <div class="cds-list" style="display:none;">
                                <input id="assignSelectorSearch" class="cds-search" placeholder="Search admins by email" />
                                <div class="cds-items" id="assignSelectorItems"></div>
                            </div>
                        </div>
                    </div>
                    <div style="font-weight:600;color:#e6eef8;margin-bottom:8px;" id="assignDeviceName"></div>
                    <div style="margin-bottom:8px;">
                        <label style="color:#9aa4b2;font-size:13px;display:block;margin-bottom:6px;">Device users</label>
                        <div id="assignAssignedAdmins" style="display:flex;flex-wrap:wrap;gap:8px"></div>
                    </div>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', assignModalHtml);

        const assignModalBackdrop = document.getElementById('assignModalBackdrop');
        const assignModalCancel = document.getElementById('assignModalCancel');
        const assignDeviceIdEl = document.getElementById('assignDeviceId');
        const assignDeviceNameEl = document.getElementById('assignDeviceName');
        const assignAssignedAdminsRoot = document.getElementById('assignAssignedAdmins');
        // selector elements (Map-style selector adapted)
        const assignSelectorRoot = document.getElementById('assignSelectorRoot');
        const assignSelectorToggle = assignSelectorRoot && assignSelectorRoot.querySelector('.cds-toggle');
        const assignSelectorList = assignSelectorRoot && assignSelectorRoot.querySelector('.cds-list');
        const assignSelectorSearch = document.getElementById('assignSelectorSearch');
        const assignSelectorItems = document.getElementById('assignSelectorItems');

        // ensure toggle has aria-expanded for accessibility
        if (assignSelectorToggle && !assignSelectorToggle.hasAttribute('aria-expanded')){
            try{ assignSelectorToggle.setAttribute('aria-expanded','false'); }catch(e){}
        }

        let currentAssignDeviceId = null;
        let currentAssignAdmins = []; // array of { UserId, Email, DeviceAssignmentId? }

        function renderAssignAssignedAdmins(){
            assignAssignedAdminsRoot.innerHTML = '';
            if (!currentAssignAdmins || currentAssignAdmins.length === 0){ const s = document.createElement('div'); s.style.color='#9aa4b2'; s.innerText = 'No device users'; assignAssignedAdminsRoot.appendChild(s); return; }
            currentAssignAdmins.forEach(a => {
                const wrap = document.createElement('div'); wrap.className = 'admin-badge'; wrap.style.display='inline-flex'; const txt = document.createElement('span'); txt.innerText = a.Email ?? String(a.UserId ?? auserId ?? a.id ?? ''); const btn = document.createElement('button'); btn.type='button'; btn.className='admin-remove'; btn.innerText='✕'; btn.addEventListener('click', async () =>{
                    // attempt to delete the assignment by DeviceAssignmentId if present, otherwise ask server to remove by user id
                    if (!currentAssignDeviceId) return;
                    if (!confirm('Unassign admin ' + (a.Email ?? a.UserId) + '?')) return;
                    try{
                        if (a.DeviceAssignmentId){
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments/${encodeURIComponent(a.DeviceAssignmentId)}`, { method: 'DELETE' });
                            if (!resp.ok) { const txt = await resp.text().catch(()=>null); showToast('Unassign failed: '+(txt||resp.status), { type:'error' }); return; }
                        } else {
                            // fallback: try delete endpoint with user id in path (not defined) - instead request server to delete by searching assignments list
                            // We'll fetch assignments and find matching DeviceAssignmentId then delete
                            const assignments = await fetchAssignmentsForDevice(currentAssignDeviceId);
                            const match = assignments.find(x => (x.UserId === (a.UserId ?? a.userId ?? a.id)));
                            if (match && match.DeviceAssignmentId){ const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments/${encodeURIComponent(match.DeviceAssignmentId)}`, { method: 'DELETE' }); if (!resp.ok){ const txt = await resp.text().catch(()=>null); showToast('Unassign failed: '+(txt||resp.status), { type:'error' }); return; } }
                            else { showToast('Could not determine assignment id to delete', { type:'error' }); return; }
                        }
                        showToast('Admin unassigned');
                        await loadAssignmentsForModal(currentAssignDeviceId);
                        fetchDevices();
                    } catch (e){ console.error(e); showToast('Unassign failed', { type:'error' }); }
                });
                wrap.appendChild(txt); wrap.appendChild(btn); assignAssignedAdminsRoot.appendChild(wrap);
            });
        }

        async function fetchAssignmentsForDevice(deviceId){
            try{
                const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(deviceId)}/assignments?offset=0&limit=100`, { cache: 'no-store' });
                if (!resp.ok) return [];
                const data = await resp.json();
                if (Array.isArray(data)) return data; if (Array.isArray(data.DeviceAssignments)) return data.DeviceAssignments; if (Array.isArray(data.deviceAssignments)) return data.deviceAssignments; return [];
            } catch (e){ console.warn('fetchAssignmentsForDevice', e); return []; }
        }

        async function loadAssignmentsForModal(deviceId){
            currentAssignAdmins = [];
            try{
                // prefer device details with assigned admin ids
                const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(deviceId)}`, { cache: 'no-store' });
                let ids;
                if (resp.ok){ const dd = await resp.json(); const dev = Array.isArray(dd) ? dd[0] : dd; const adminsSrc = dev.AssignedAdmins ?? dev.Admins ?? dev.AdminIds ?? dev.admins ?? [];
                    if (Array.isArray(adminsSrc) && adminsSrc.length){
                        // normalize to UserId and DeviceAssignmentId (if present)
                        currentAssignAdmins = adminsSrc.map(a => ({ UserId: a.UserId ?? a.userId ?? a.id ?? a, DeviceAssignmentId: a.DeviceAssignmentId ?? a.deviceAssignmentId ?? a.DeviceAssignmentId }));
                    }
                }
                // if still empty, fallback to assignments endpoint
                if (!currentAssignAdmins.length){
                    const assignments = await fetchAssignmentsForDevice(deviceId);
                    currentAssignAdmins = assignments.map(a => ({ UserId: a.UserId ?? a.userId ?? a.UserId, DeviceAssignmentId: a.DeviceAssignmentId ?? a.deviceAssignmentId ?? a.Id }));
                }
                // resolve emails for the gathered user ids
                ids = currentAssignAdmins.map(a => a.UserId).filter(Boolean);
                if (ids.length){
                    const users = await fetchUsersByIds(ids);
                    const byId = {};
                    users.forEach(u => { const id = u.UserId ?? u.userId ?? u.id ?? u.Id ?? null; if (id) byId[id] = u; });
                    currentAssignAdmins = currentAssignAdmins.map(a => ({ ...a, Email: (byId[a.UserId] && (byId[a.UserId].Email ?? byId[a.UserId].email)) || a.Email || String(a.UserId) }));
                }
            } catch (e){ console.warn('loadAssignmentsForModal', e); }
            renderAssignAssignedAdmins();
        }

        // helper: fetch user details by ids using the server endpoint
        async function fetchUsersByIds(userIds){
            try{
                if (!userIds || userIds.length === 0) return [];
                const q = userIds.map(id => encodeURIComponent(id)).join(',');
                const url = `/v1/admin/users?userIds=${q}`;
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) return [];
                const data = await resp.json();
                if (Array.isArray(data)) return data;
                if (Array.isArray(data.Users)) return data.Users;
                if (Array.isArray(data.users)) return data.users;
                return [];
            } catch (e){ console.warn('fetchUsersByIds', e); return []; }
        }

        // New selector-driven assign search/assign logic (Map-style selector adapted)
        let assignSearchToken = 0;
        let assignItemNodes = []; // for keyboard navigation
        let assignFocusedIndex = -1;

        // small helper to escape text (used by selector rendering)
        function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

        // populate items into the .cds-items element
        async function doAssignSelectorSearchPopulate(q){
            assignSelectorItems.innerHTML = '';
            assignItemNodes = [];
            assignFocusedIndex = -1;
            if (!q){
                // show empty prompt
                const empty = document.createElement('div'); empty.className = 'cds-empty'; empty.innerText = 'Type to search admins'; assignSelectorItems.appendChild(empty); return;
            }
            const token = ++assignSearchToken;
            const results = await fetchAdmins(q);
            if (token !== assignSearchToken) return;
            if (!results || results.length === 0){ const e = document.createElement('div'); e.className = 'cds-empty'; e.innerText = 'No admins'; assignSelectorItems.appendChild(e); return; }

            // Exclude users that are already assigned to the currently opened device (client-side filter)
            try{
                const assignedIds = new Set((currentAssignAdmins || []).map(a => String(a.UserId ?? a.userId ?? a.id ?? '')));
                // filter out any result whose id is present in assignedIds
                const filtered = results.filter(r => {
                    const rid = String(r.UserId ?? r.userId ?? r.id ?? r.Id ?? '');
                    return rid && !assignedIds.has(rid);
                });

                if (!filtered || filtered.length === 0){ const e = document.createElement('div'); e.className = 'cds-empty'; e.innerText = 'No admins'; assignSelectorItems.appendChild(e); return; }

                filtered.forEach(r => {
                    const id = r.UserId ?? r.userId ?? r.id ?? r.Id ?? null; const email = r.Email ?? r.email ?? r.EmailAddress ?? String(id ?? '');
                    const it = document.createElement('div'); it.className = 'cds-item'; it.tabIndex = -1; it.dataset.value = id ?? '';
                    it.innerHTML = `<div class="name">${escapeHtml(email)}</div><div class="id">${escapeHtml(String(id ?? ''))}</div>`;
                    it.addEventListener('click', async ()=>{
                        if (!currentAssignDeviceId) return; const exists = currentAssignAdmins.some(x => (String(x.UserId) === String(id))); if (exists){ showToast('Admin already assigned'); closeAssignSelector(); return; }
                        try{
                            const payload = { UserId: id, DeviceId: currentAssignDeviceId };
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                            if (resp.ok){
                                // update visible label to reflect assigned admin (matches Map selector behavior)
                                try{
                                    const lbl = assignSelectorToggle && assignSelectorToggle.querySelector('.label');
                                    if (lbl) lbl.innerText = 'Assigned: ' + String(email);
                                } catch(e){}
                                showToast('Admin assigned');
                                await loadAssignmentsForModal(currentAssignDeviceId);
                                fetchDevices();
                                closeAssignSelector();
                            } else { const txt = await resp.text().catch(()=>null); showToast('Assign failed: '+(txt||resp.status), { type:'error' }); }
                        } catch (e){ console.error(e); showToast('Assign failed', { type:'error' }); }
                    });
                    assignSelectorItems.appendChild(it);
                    assignItemNodes.push({ el: it, id: String(id ?? ''), label: String(email).toLowerCase() });
                });
            } catch(e){
                console.warn('doAssignSelectorSearchPopulate filter error', e);
                // fallback to showing original results unfiltered if something unexpected happens
                results.forEach(r => {
                    const id = r.UserId ?? r.userId ?? r.id ?? r.Id ?? null; const email = r.Email ?? r.email ?? r.EmailAddress ?? String(id ?? '');
                    const it = document.createElement('div'); it.className = 'cds-item'; it.tabIndex = -1; it.dataset.value = id ?? '';
                    it.innerHTML = `<div class="name">${escapeHtml(email)}</div><div class="id">${escapeHtml(String(id ?? ''))}</div>`;
                    it.addEventListener('click', async ()=>{
                        if (!currentAssignDeviceId) return; const exists = currentAssignAdmins.some(x => (x.UserId === id)); if (exists){ showToast('Admin already assigned'); closeAssignSelector(); return; }
                        try{
                            const payload = { UserId: id, DeviceId: currentAssignDeviceId };
                            const resp = await fetch(`/v1/admin/devices/${encodeURIComponent(currentAssignDeviceId)}/assignments`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                            if (resp.ok){
                                try{ const lbl = assignSelectorToggle && assignSelectorToggle.querySelector('.label'); if (lbl) lbl.innerText = 'Assigned: ' + String(email); } catch(e){}
                                showToast('Admin assigned');
                                await loadAssignmentsForModal(currentAssignDeviceId);
                                fetchDevices();
                                closeAssignSelector();
                            } else { const txt = await resp.text().catch(()=>null); showToast('Assign failed: '+(txt||resp.status), { type:'error' }); }
                        } catch (e){ console.error(e); showToast('Assign failed', { type:'error' }); }
                    });
                    assignSelectorItems.appendChild(it);
                    assignItemNodes.push({ el: it, id: String(id ?? ''), label: String(email).toLowerCase() });
                });
            }
        }

        // keyboard navigation helpers for assign selector
        function assignFocusIndex(idx){
            if (!assignItemNodes || assignItemNodes.length === 0) return;
            if (assignFocusedIndex >= 0 && assignItemNodes[assignFocusedIndex]) assignItemNodes[assignFocusedIndex].el.classList.remove('focused');
            assignFocusedIndex = Math.max(0, Math.min(idx, assignItemNodes.length - 1));
            const node = assignItemNodes[assignFocusedIndex];
            if (node){ node.el.classList.add('focused'); node.el.scrollIntoView({ block: 'nearest' }); }
        }

        if (assignSelectorRoot){
            assignSelectorRoot.addEventListener('keydown', (ev) => {
                if (ev.key === 'ArrowDown') { ev.preventDefault(); if (!assignItemNodes || assignItemNodes.length === 0) return; openAssignSelector(); assignFocusIndex(assignFocusedIndex + 1); }
                else if (ev.key === 'ArrowUp') { ev.preventDefault(); if (!assignItemNodes || assignItemNodes.length === 0) return; openAssignSelector(); assignFocusIndex(assignFocusedIndex - 1); }
                else if (ev.key === 'Enter') { ev.preventDefault(); if (assignFocusedIndex >= 0 && assignItemNodes[assignFocusedIndex]) assignItemNodes[assignFocusedIndex].el.click(); }
                else if (ev.key === 'Escape') { closeAssignSelector(); }
            });
        }

        // --- NEW: implement open/close/toggle and wire selector interactions ---
        // These were missing and caused errors when trying to open/type in the selector.
        function openAssignSelector(){
            try{
                if (!assignSelectorList || !assignSelectorRoot) return;
                assignSelectorList.style.display = '';
                assignSelectorRoot.classList.add('cds-open');
                if (assignSelectorToggle) try{ assignSelectorToggle.setAttribute('aria-expanded','true'); } catch(e){}
                // populate existing value or show prompt
                try { doAssignSelectorSearchPopulate(assignSelectorSearch && assignSelectorSearch.value ? assignSelectorSearch.value.trim() : ''); } catch (e) {}
                // focus search input so typing works immediately
            } catch(e){ console.warn('openAssignSelector', e); }
        }

        function closeAssignSelector(){
            try{
                if (!assignSelectorList || !assignSelectorRoot) return;
                assignSelectorList.style.display = 'none';
                assignSelectorRoot.classList.remove('cds-open');
                if (assignSelectorToggle) try{ assignSelectorToggle.setAttribute('aria-expanded','false'); } catch(e){}
                // reset items state
                assignItemNodes = [];
                assignFocusedIndex = -1;
            } catch(e){ console.warn('closeAssignSelector', e); }
        }

        function toggleAssignSelector(){
            try{
                if (!assignSelectorList) return;
                const isHidden = getComputedStyle(assignSelectorList).display === 'none';
                if (isHidden) openAssignSelector(); else closeAssignSelector();
            } catch(e){ console.warn('toggleAssignSelector', e); }
        }

        // Wire click on toggle to open/close and handle keyboard on toggle
        if (assignSelectorToggle){
            assignSelectorToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleAssignSelector(); });
            assignSelectorToggle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleAssignSelector(); }
                if (e.key === 'ArrowDown') { e.preventDefault(); openAssignSelector();  }
            });
        }

        // Debounced search wiring so typing in the selector triggers searches
        if (assignSelectorSearch){
            const debouncedAssignSearch = debounce(() => { try { doAssignSelectorSearchPopulate(assignSelectorSearch.value.trim()); } catch (e) { console.warn(e); } }, 220);
            assignSelectorSearch.addEventListener('input', debouncedAssignSearch);
            assignSelectorSearch.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') { e.preventDefault(); assignFocusIndex(0); }
                else if (e.key === 'Escape') { e.preventDefault(); closeAssignSelector(); }
            });
        }

        // Close selector when clicking outside
        document.addEventListener('click', (e) => { try { if (!assignSelectorRoot) return; if (!assignSelectorRoot.contains(e.target)) closeAssignSelector(); } catch (e) {} });

        // Wire assign modal close handlers (fix: previously missing handlers so modal could not be closed)
        function closeAssignModal(){
            try {
                if (assignModalBackdrop) {
                    assignModalBackdrop.classList.remove('open');
                    assignModalBackdrop.setAttribute('aria-hidden','true');
                    document.body.style.overflow = '';
                }
            } catch(e){}
            // also close the selector and restore focus to the element that opened the modal
            try { closeAssignSelector(); } catch(e){}
        }
        if (assignModalCancel) assignModalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeAssignModal(); });
        if (assignModalBackdrop) assignModalBackdrop.addEventListener('click', (e)=>{ if (e.target === assignModalBackdrop) closeAssignModal(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && assignModalBackdrop && assignModalBackdrop.classList.contains('open')) { closeAssignModal(); } });

        function openAssignmentsModal(device){
            try { lastFocusedEl = document.activeElement; } catch (e){}

            let backdrop = typeof assignModalBackdrop !== 'undefined' ? assignModalBackdrop : null;
            if (!backdrop){
                showToast('Unable to open Assignments modal (DOM not present)', { type:'error' });
                return;
            }

            console.log('Opening Assignments modal for device', device);
            backdrop.classList.add('open'); backdrop.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';

            const id = device.DeviceId ?? device.deviceId ?? device.id ?? device.Id ?? null;
            currentAssignDeviceId = id;
            try{ assignDeviceIdEl.value = id || ''; } catch(e){}
            try{ assignDeviceNameEl.innerText = device.DeviceName ?? device.deviceName ?? device.Name ?? device.name ?? ''; } catch(e){}
            try{ if (typeof loadAssignmentsForModal === 'function') loadAssignmentsForModal(id); else console.warn('loadAssignmentsForModal not available'); } catch (e){ console.warn('Error loading assignments for modal', e); }
            // focus selector when opened
        }

        // expose for debugging/console use in case callers expect a global
        try {
            if (typeof window !== 'undefined') window.openAssignmentsModal = openAssignmentsModal;
        } catch (e) { /* ignore in non-browser environments */ }

        // init
        fetchDevices();
    })();
    </script>
</body>
</html>
