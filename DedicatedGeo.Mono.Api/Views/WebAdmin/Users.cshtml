@{
    Layout = null; // standalone admin users page styled like Login.cshtml
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Users Management</title>

    <style>
        /* Using concrete colors instead of CSS variables to avoid analyzer warnings about unresolved custom properties */
        html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, rgba(3,7,12,1), rgba(6,10,16,1)); color: #e6eef8; }

        .root{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:32px; box-sizing:border-box; }

        .card{
            width: min(920px, 96vw);
            margin-top:32px;
            background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98));
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(2,6,23,0.6);
            display:flex; flex-direction:column; gap:16px;
        }

        .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
        .card-header h1{ margin:0; font-size:18px; }
        .card-sub{ color:#9aa4b2; font-size:13px; }

        .controls{ display:flex; gap:8px; align-items:center; }
        .search{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:#e6eef8; }

        table.users{ width:100%; border-collapse:collapse; font-size:14px; }
        table.users thead th{ text-align:left; color:#9aa4b2; font-weight:600; padding:10px; font-size:13px; }
        table.users tbody td{ padding:10px; border-top:1px solid rgba(255,255,255,0.02); }
        table.users tbody tr:hover td{ background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }

        /* Buttons (match Login.cshtml style) */
        .btn-primary{
            background: linear-gradient(90deg, #7c5cff, #5ab3ff);
            border:none; color:white; padding:10px 14px; font-weight:700; border-radius:10px; cursor:pointer; font-size:14px;
            box-shadow: 0 8px 30px rgba(90,179,255,0.06);
        }
        .btn-ghost{
            background: transparent; border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600;
        }
        .btn-danger{ background: linear-gradient(180deg,#ef4444,#c81b1b); color:white; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }

        .pagination{ display:flex; gap:8px; align-items:center; }
        /* Page size select: make the native select visually match the app's styled controls
           Use appearance: none and background caret so it looks like the custom selects. */
        .page-input{
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding:6px 36px 6px 8px; /* room on the right for a caret */
            border-radius:8px; border:1px solid rgba(255,255,255,0.03);
            background-image: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)),
                              linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.25) 50%),
                              linear-gradient(135deg, rgba(255,255,255,0.25) 50%, transparent 50%);
            background-position: left top, calc(100% - 16px) calc(1em + 2px), calc(100% - 12px) calc(1em + 2px);
            background-size: auto, .5em .5em, .5em .5em;
            background-repeat: no-repeat;
            background-color: transparent;
            color:#e6eef8; cursor:pointer; box-sizing:border-box;
        }
        /* Small vendor tweak to hide the native dropdown arrow in IE/Edge */
        .page-input::-ms-expand{ display:none; }
        /* Focus state to match other controls */
        .page-input:focus{ outline:2px solid rgba(90,179,255,0.12); box-shadow: 0 6px 18px rgba(90,179,255,0.04); }
        /* Style the option elements in the dropdown so they match the page background when possible */
        .page-input option{ background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); color:#e6eef8; padding:6px 8px; }

        /* Modal (create/edit) */
        .modal-backdrop{ position:fixed; inset:0; background: rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:1400; }
        .modal-backdrop.open{ display:flex; }
        .modal-card{ width: min(560px, 96vw); background: linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:16px; border-radius:12px; box-shadow: 0 24px 80px rgba(2,6,23,0.6); }
        .form-row{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
        label{ color:#9aa4b2; font-size:13px; }
        input[type="text"], input[type="email"], input[type="password"], select{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border: 1px solid rgba(255,255,255,0.04); color: #e6eef8; padding: 10px 12px; border-radius: 10px; outline:none; }

        .row{ display:flex; gap:8px; align-items:center; }

        .toast-container{ position: fixed; top: 16px; right: 16px; z-index: 1600; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
        .toast{ min-width: 220px; max-width: 88vw; background: linear-gradient(180deg, rgba(11,18,28,0.95), rgba(6,10,16,0.98)); color: #e6eef8; border: 1px solid rgba(255,255,255,0.04); padding: 10px 12px; border-radius: 10px; box-shadow: 0 12px 36px rgba(2,6,23,0.6); font-size:13px; display:flex; align-items:center; gap:10px; }
        .toast.error{ border-color: rgba(239,68,68,0.18); background: linear-gradient(180deg, rgba(239,68,68,0.06), rgba(11,18,28,0.95)); color:#fff2f2; }

        /* small centered spinner used for table loading and button states */
        .spinner{ width:28px; height:28px; border-radius:999px; border:3px solid rgba(255,255,255,0.06); border-top-color:#5ab3ff; animation:spin 1s linear infinite; }
        @@keyframes spin{ to { transform:rotate(360deg); } }

        /* Custom select style to match page design */
        .select-role{
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding-right: 36px; /* room for a custom arrow */
            background-image: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)),
                              linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.25) 50%),
                              linear-gradient(135deg, rgba(255,255,255,0.25) 50%, transparent 50%);
            background-position: calc(100% - 12px) calc(1em + 2px), calc(100% - 16px) calc(1em + 2px), calc(100% - 12px) calc(1em + 2px);
            background-size: 1em 1em, .5em .5em, .5em .5em;
            background-repeat: no-repeat;
            cursor: pointer;
        }

        /* Role badge styles for table display */
        .role-badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; color:#e6eef8; }
        .role-superadmin{ background: linear-gradient(90deg,#7c5cff,#b06cff); color:white; }
        .role-admin{ background: linear-gradient(90deg,#5ab3ff,#2db5ff); color:#012; }
        .role-deviceuser{ background: linear-gradient(90deg,#2dd4bf,#34d399); color:#012; }

        /* Custom role selector (replaces visual select options) */
        .role-select-wrap{ position:relative; display:flex; align-items:center; gap:8px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:10px; cursor:pointer; min-width:220px; box-sizing:border-box; }
        .role-select-value{ display:flex; align-items:center; gap:8px; cursor:pointer; color:#e6eef8; }
        /* caret */
        .role-select-value::after{ content: ''; display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:7px solid rgba(255,255,255,0.7); margin-left:6px; transform:translateY(1px); }
        .role-options{ position:absolute; top:calc(100% + 8px); left:0; min-width:100%; background:linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:8px; border-radius:12px; display:none; z-index:1500; box-shadow:0 18px 60px rgba(2,6,23,0.6); box-sizing:border-box; }
        .role-options.open{ display:block; }
        .role-option{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:6px 8px; border-radius:10px; cursor:pointer; }
        .role-option:hover{ background: rgba(255,255,255,0.02); }
        .role-option:focus{ outline:2px solid rgba(90,179,255,0.12); }
        .role-option .role-badge{ display:inline-block; }

        /* Custom page-size selector visuals (small version of the role selector) */
        .page-select-wrap{ position:relative; display:flex; align-items:center; gap:8px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:8px; cursor:pointer; min-width:90px; box-sizing:border-box; }
        .page-select-value{ color:#e6eef8; font-weight:600; }
        .page-select-value::after{ content: ''; display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:7px solid rgba(255,255,255,0.7); margin-left:8px; transform:translateY(1px); }
        .page-options{ position:absolute; top:calc(100% + 8px); left:0; min-width:100%; background:linear-gradient(180deg, rgba(11,18,28,0.98), rgba(6,10,16,0.95)); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:8px; display:none; z-index:1500; box-shadow:0 18px 60px rgba(2,6,23,0.6); box-sizing:border-box; }
        .page-options.open{ display:block; }
        .page-option{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:6px 8px; border-radius:8px; cursor:pointer; color:#e6eef8; }
        .page-option:hover{ background: rgba(255,255,255,0.02); }
        .page-option:focus{ outline:2px solid rgba(90,179,255,0.12); }

        @@media (max-width:720px){ .card{ width:94vw; margin-top:18px; } table.users thead{ display:none; } table.users tbody td{ display:block; width:100%; } }
 
    </style>
</head>
<body>
    <main class="root" role="main">
        <section class="card" aria-labelledby="usersTitle">
            <div class="card-header">
                <div>
                    <h1 id="usersTitle">User Management</h1>
                    <div class="card-sub">Create, edit and delete users.</div>
                </div>
                <div class="controls">
                    <input id="searchInput" class="search" placeholder="Filter by email" />
                    <button id="createBtn" class="btn-primary">Create user</button>
                </div>
            </div>

            <div id="tableWrapper" style="position:relative;overflow:auto;">
                <div id="tableSpinner" class="spinner" aria-hidden="true" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);"></div>
                <table class="users" id="usersTable" aria-describedby="usersTitle" aria-busy="false">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th style="width:180px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- populated by JS -->
                    </tbody>
                </table>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
                <div class="pagination">
                    <button id="prevPage" class="btn-ghost">Previous</button>
                    <div style="display:flex;align-items:center;gap:8px;color:#9aa4b2">
                        Page <span id="currentPage">1</span>
                    </div>
                    <button id="nextPage" class="btn-ghost">Next</button>
                </div>

                <div style="display:flex;align-items:center;gap:8px;">
                    <label id="pageSizeLabel" style="color:#9aa4b2;font-size:13px;">Page size</label>
                    <!-- Hidden native select retained for accessibility/semantics; visual UI below mirrors it -->
                    <select id="pageSize" class="page-input" aria-hidden="true" style="display:none;">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>

                    <!-- Custom visual page-size selector to match app styling -->
                    <div class="page-select-wrap" id="pageSizeWrap" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="pageSizeLabel">
                        <div class="page-select-value" id="pageSizeDisplay">10</div>
                        <div class="page-options" id="pageSizeOptions" role="listbox" tabindex="-1">
                            <button type="button" class="page-option" data-value="10">10</button>
                            <button type="button" class="page-option" data-value="25">25</button>
                            <button type="button" class="page-option" data-value="50">50</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div>
                    <div id="modalTitle" style="font-weight:700;font-size:16px;color:#e6eef8">Create user</div>
                    <div id="modalSub" style="color:#9aa4b2;font-size:13px"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button id="modalCancel" class="btn-ghost">Cancel</button>
                    <button id="modalSave" class="btn-primary">Save</button>
                </div>
            </div>

            <form id="userForm" style="margin-top:12px;">
                <input type="hidden" id="userId" />
                <div class="form-row">
                    <label for="email">Email</label>
                    <input id="email" type="email" required />
                </div>
                <div class="form-row">
                    <label for="role">Role</label>

                    <!-- Hidden native select retained for form semantics and server side; visually we provide a custom selector below -->
                    <select id="role" class="select-role" aria-hidden="true" style="display:none;">
                        <option value="SuperAdmin">SuperAdmin</option>
                        <option value="Admin">Admin</option>
                        <option value="DeviceUser">DeviceUser</option>
                    </select>

                    <!-- Custom visual selector that matches page badges -->
                    <div class="role-select-wrap" id="roleSelectWrap" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <div class="role-select-value" id="roleDisplay" aria-live="polite">
                            <span class="role-badge role-deviceuser">DeviceUser</span>
                        </div>

                        <div class="role-options" id="roleOptions" role="listbox" aria-labelledby="roleDisplay" tabindex="-1">
                            <button type="button" class="role-option" data-value="SuperAdmin">
                                <span class="role-badge role-superadmin">SuperAdmin</span>
                            </button>
                            <button type="button" class="role-option" data-value="Admin">
                                <span class="role-badge role-admin">Admin</span>
                            </button>
                            <button type="button" class="role-option" data-value="DeviceUser">
                                <span class="role-badge role-deviceuser">DeviceUser</span>
                            </button>
                        </div>
                    </div>

                </div>
                <div class="form-row">
                    <label for="password">Password <span style="color:#9aa4b2;font-size:12px">(leave empty to keep on edit)</span></label>
                    <input id="password" type="password" />
                </div>
            </form>
        </div>
    </div>

    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        (function(){
            // Utility: debounce to avoid firing search on every keystroke
            function debounce(fn, wait){ let t = null; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); }; }

            // Loading helpers
            const tableSpinner = document.getElementById('tableSpinner');
            function showLoading(){ if (tableSpinner) tableSpinner.style.display = ''; document.getElementById('usersTable').setAttribute('aria-busy','true'); prevPageBtn.disabled = true; nextPageBtn.disabled = true; }
            function hideLoading(){ if (tableSpinner) tableSpinner.style.display = 'none'; document.getElementById('usersTable').setAttribute('aria-busy','false'); }

            // Focus management for modal: restore focus to the opener when closing
            let lastFocusedEl = null;
            // Only restore focus to the role selector when the options were explicitly opened by the user
            let roleOptionsShouldRestoreFocus = false;

            const usersTableBody = document.querySelector('#usersTable tbody');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const currentPageEl = document.getElementById('currentPage');
            const pageSizeEl = document.getElementById('pageSize');
            const searchInput = document.getElementById('searchInput');

            const modalBackdrop = document.getElementById('modalBackdrop');
            const modalTitle = document.getElementById('modalTitle');
            const modalSave = document.getElementById('modalSave');
            const modalCancel = document.getElementById('modalCancel');
            const userIdEl = document.getElementById('userId');
            const emailEl = document.getElementById('email');
            const roleEl = document.getElementById('role');
            const passwordEl = document.getElementById('password');

            const createBtn = document.getElementById('createBtn');
            const toastContainer = document.getElementById('toastContainer');

            // Custom role selector elements
            const roleSelectWrap = document.getElementById('roleSelectWrap');
            const roleOptions = document.getElementById('roleOptions');
            const roleDisplay = document.getElementById('roleDisplay');
            const roleOptionButtons = Array.from(document.querySelectorAll('.role-option'));

            // Custom page size selector elements
            const pageSizeWrap = document.getElementById('pageSizeWrap');
            const pageSizeOptions = document.getElementById('pageSizeOptions');
            const pageSizeDisplay = document.getElementById('pageSizeDisplay');
            const pageOptionButtons = Array.from(document.querySelectorAll('.page-option'));

            // Helpers to sync hidden select and the custom UI
            function updateRoleDisplay(){
                 const val = roleEl.value || 'DeviceUser';
                 const normalized = String(val);
                 const cls = 'role-' + normalized.toLowerCase().replace(/[^a-z0-9]/g, '');
                 roleDisplay.innerHTML = '<span class="role-badge ' + cls + '">' + normalized + '</span>';
                 // update aria-expanded attribute
                 if (roleSelectWrap) roleSelectWrap.setAttribute('aria-expanded', roleOptions.classList.contains('open'));
             }

            function updatePageSizeDisplay(){
                try { pageSizeDisplay.innerText = pageSizeEl.value || '10'; } catch (e) {}
                if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded', pageSizeOptions.classList.contains('open'));
            }

            // Open/close helpers for the custom role options. Use a guard flag so we only restore
            // focus to the selector when the options were opened by the user (avoids unexpected focus jumps).
            function openRoleOptions(){
                roleOptions.classList.add('open');
                if (roleSelectWrap) roleSelectWrap.setAttribute('aria-expanded','true');
                try { roleOptions.focus(); } catch (e) {}
                // remember that the user opened the options so closing should restore focus
                roleOptionsShouldRestoreFocus = true;
            }

            function closeRoleOptions(){
                roleOptions.classList.remove('open');
                if (roleSelectWrap) roleSelectWrap.setAttribute('aria-expanded','false');
                // only restore focus to the role UI when the options were opened by the user
                if (roleOptionsShouldRestoreFocus && roleSelectWrap) {
                    try { roleSelectWrap.focus(); } catch (e) {}
                }
                roleOptionsShouldRestoreFocus = false;
            }

            // Open/close helpers for the custom page size options
            function openPageOptions(){
                pageSizeOptions.classList.add('open');
                if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded','true');
                try { pageSizeOptions.focus(); } catch (e) {}
            }
            function closePageOptions(){
                pageSizeOptions.classList.remove('open');
                if (pageSizeWrap) pageSizeWrap.setAttribute('aria-expanded','false');
                try { pageSizeWrap.focus(); } catch (e) {}
            }

            // Wire interactions
             if (roleSelectWrap){
                roleSelectWrap.addEventListener('click', (e)=>{
                    e.stopPropagation(); if (roleOptions.classList.contains('open')) closeRoleOptions(); else openRoleOptions();
                });
                // keyboard support
                roleSelectWrap.addEventListener('keydown', (e)=>{
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (roleOptions.classList.contains('open')) closeRoleOptions(); else openRoleOptions(); }
                    if (e.key === 'ArrowDown'){ e.preventDefault(); openRoleOptions(); const first = roleOptionButtons[0]; if (first) first.focus(); }
                });
            }

            // clicking an option sets the hidden select and updates UI
            roleOptionButtons.forEach(btn => {
                btn.addEventListener('click', ()=>{
                    const v = btn.getAttribute('data-value');
                    if (v){ roleEl.value = v; updateRoleDisplay(); }
                    closeRoleOptions();
                });
                // keyboard selection inside options
                btn.addEventListener('keydown', (e)=>{
                    const idx = roleOptionButtons.indexOf(btn);
                    if (e.key === 'ArrowDown'){ e.preventDefault(); const next = roleOptionButtons[idx+1]; if (next) next.focus(); }
                    if (e.key === 'ArrowUp'){ e.preventDefault(); const prev = roleOptionButtons[idx-1]; if (prev) prev.focus(); }
                    if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); }
                });
            });

            // Page size custom selector wiring
            if (pageSizeWrap){
                pageSizeWrap.addEventListener('click', (e)=>{ e.stopPropagation(); if (pageSizeOptions.classList.contains('open')) closePageOptions(); else openPageOptions(); });
                pageSizeWrap.addEventListener('keydown', (e)=>{
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (pageSizeOptions.classList.contains('open')) closePageOptions(); else openPageOptions(); }
                    if (e.key === 'ArrowDown'){ e.preventDefault(); openPageOptions(); const first = pageOptionButtons[0]; if (first) first.focus(); }
                });
            }

            pageOptionButtons.forEach(btn => {
                btn.addEventListener('click', ()=>{
                    const v = btn.getAttribute('data-value');
                    if (v){ pageSizeEl.value = v; updatePageSizeDisplay(); }
                    closePageOptions();
                    // reflect change
                    offset = 0; fetchUsers();
                });
                btn.addEventListener('keydown', (e)=>{
                    const idx = pageOptionButtons.indexOf(btn);
                    if (e.key === 'ArrowDown'){ e.preventDefault(); const next = pageOptionButtons[idx+1]; if (next) next.focus(); }
                    if (e.key === 'ArrowUp'){ e.preventDefault(); const prev = pageOptionButtons[idx-1]; if (prev) prev.focus(); }
                    if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); }
                });
            });

            // close options when clicking outside
            document.addEventListener('click', (e)=>{ if (!roleSelectWrap) return; if (!roleSelectWrap.contains(e.target)) closeRoleOptions(); });
            document.addEventListener('click', (e)=>{ if (!pageSizeWrap) return; if (!pageSizeWrap.contains(e.target)) closePageOptions(); });

            // ensure display reflects underlying value when modal opens
            // The openModal function below calls updateRoleDisplay when preparing the modal; also initialize the display now.

            let offset = 0;
            let limit = Number(pageSizeEl.value) || 10;
            let currentPage = 1;
            let totalCount = null; // may be unknown

            function showToast(message, { type = 'default', duration = 4000 } = {}){
                const t = document.createElement('div');
                t.className = 'toast' + (type === 'error' ? ' error' : '');
                t.setAttribute('role','status');
                t.textContent = message;
                const close = document.createElement('button'); close.type = 'button'; close.innerText = 'Close'; close.className = 'btn-ghost'; close.style.marginLeft = '8px';
                close.addEventListener('click', ()=> t.remove());
                t.appendChild(close);
                toastContainer.appendChild(t);
                if (duration > 0) setTimeout(()=>{ try{ t.remove(); }catch(e){} }, duration);
            }

            async function openModal(mode, user){
                 // remember opener so we can restore focus when modal closes
                 try { lastFocusedEl = document.activeElement; } catch (e) {}
                modalBackdrop.classList.add('open');
                modalBackdrop.setAttribute('aria-hidden','false');
                // prevent background scroll while modal is open
                document.body.style.overflow = 'hidden';

                if (mode === 'create'){
                    modalTitle.innerText = 'Create user';
                    userIdEl.value = '';
                    emailEl.value = '';
                    roleEl.value = 'DeviceUser';
                    passwordEl.value = '';
                    updateRoleDisplay();
                    emailEl.focus();
                } else {
                    modalTitle.innerText = 'Edit user';
                    // prefer to fetch freshest data from server when possible
                    const id = user.UserId ?? user.userId ?? user.id ?? null;
                    if (!id) {
                        // fallback to provided object
                        userIdEl.value = user.UserId ?? user.userId ?? user.id ?? '';
                        emailEl.value = user.Email ?? user.email ?? '';
                        roleEl.value = user.Role ?? user.role ?? 'DeviceUser';
                        passwordEl.value = '';
                        updateRoleDisplay();
                        emailEl.focus();
                    } else {
                        // fetch single user resource for authoritative data
                        try {
                            // show temporary busy state in modal save button
                            modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');
                            const resp = await fetch(`/v1/admin/users/${encodeURIComponent(id)}`, { cache: 'no-store' });
                            if (resp.ok) {
                                const data = await resp.json();
                                const u = (data && (Array.isArray(data) ? data[0] : data)) || user;
                                userIdEl.value = u.UserId ?? u.userId ?? u.id ?? id;
                                emailEl.value = u.Email ?? u.email ?? '';
                                roleEl.value = u.Role ?? u.role ?? 'DeviceUser';
                                passwordEl.value = '';
                                updateRoleDisplay();
                            } else {
                                // fallback to passed-in object
                                userIdEl.value = id;
                                emailEl.value = user.Email ?? user.email ?? '';
                                roleEl.value = user.Role ?? user.role ?? 'DeviceUser';
                                passwordEl.value = '';
                                updateRoleDisplay();
                                showToast('Failed to refresh user details; using cached values', { type: 'error', duration: 3000 });
                            }
                        } catch (e) {
                            console.warn('Failed to fetch single user', e);
                            userIdEl.value = id;
                            emailEl.value = user.Email ?? user.email ?? '';
                            roleEl.value = user.Role ?? user.role ?? 'DeviceUser';
                            passwordEl.value = '';
                            updateRoleDisplay();
                        } finally {
                            modalSave.disabled = false; modalSave.removeAttribute('aria-busy');
                            emailEl.focus();
                        }
                    }
                }
            }

            function closeModal(){
                modalBackdrop.classList.remove('open');
                modalBackdrop.setAttribute('aria-hidden','true');
                // restore scrolling
                document.body.style.overflow = '';
                // restore focus to the element that opened the modal
                try { if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') lastFocusedEl.focus(); } catch (e) {}
            }

            modalCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
            modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });
            // Close modal on Escape
            document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modalBackdrop.classList.contains('open')) { closeModal(); } });

            createBtn.setAttribute('aria-label','Create user');
            createBtn.addEventListener('click', (e)=> { lastFocusedEl = e.currentTarget; openModal('create'); });

            async function fetchUsers(){
                try{
                    showLoading();
                    limit = Number(pageSizeEl.value) || 10;
                    const q = encodeURIComponent(searchInput.value || '');
                    const url = `/v1/admin/users?offset=${offset}&limit=${limit}` + (q ? `&search=${q}` : '');
                    const resp = await fetch(url, { cache: 'no-store' });
                    if (!resp.ok){ showToast('Failed to load users', { type: 'error' }); return; }
                    const data = await resp.json();
                    // Accept several shapes: { Users: [...], Total: n } or array
                    let items;
                    if (Array.isArray(data)) items = data;
                    else if (Array.isArray(data.Users)) items = data.Users;
                    else if (Array.isArray(data.users)) items = data.users;
                    else items = [];

                    // try to extract total count
                    if (typeof data.Total === 'number') totalCount = data.Total;
                    else if (typeof data.total === 'number') totalCount = data.total;
                    else totalCount = null;

                    renderUsers(items);
                } catch (e){ console.error('fetchUsers error', e); showToast('Failed to load users', { type: 'error' }); }
                finally { hideLoading(); }
            }

            function renderUsers(items){
                usersTableBody.innerHTML = '';
                if (!items || items.length === 0){
                    const tr = document.createElement('tr');
                    const td = document.createElement('td'); td.colSpan = 3; td.style.color = '#9aa4b2'; td.innerText = 'No users';
                    tr.appendChild(td); usersTableBody.appendChild(tr); return;
                }

                items.forEach(u => {
                    const tr = document.createElement('tr');
                    const email = document.createElement('td'); email.innerText = u.Email ?? u.email ?? '';
                    const role = document.createElement('td');
                    // render role as a styled badge to match page design
                    const roleText = (u.Role ?? u.role ?? 'DeviceUser');
                    const badge = document.createElement('span');
                    const safeClass = ('role-' + String(roleText).toLowerCase().replace(/[^a-z0-9]/g, ''));
                    badge.className = 'role-badge ' + safeClass;
                    badge.innerText = roleText;
                    role.appendChild(badge);

                    const actions = document.createElement('td'); actions.style.display = 'flex'; actions.style.gap = '8px';

                    const edit = document.createElement('button'); edit.className = 'btn-ghost'; edit.innerText = 'Edit';
                    edit.addEventListener('click', (e)=> { lastFocusedEl = e.currentTarget; openModal('edit', u) });

                    const del = document.createElement('button'); del.className = 'btn-danger'; del.innerText = 'Delete';
                    del.addEventListener('click', (e)=> deleteUser(u, e.currentTarget));

                    actions.appendChild(edit); actions.appendChild(del);
                    tr.appendChild(email); tr.appendChild(role); tr.appendChild(actions);
                    usersTableBody.appendChild(tr);
                });

                // update page indicator
                const page = Math.floor(offset / limit) + 1; currentPage = page; currentPageEl.innerText = String(page);

                // enable/disable prev/next depending on totalCount or items length
                prevPageBtn.disabled = offset === 0;
                if (totalCount !== null){
                    nextPageBtn.disabled = offset + limit >= totalCount;
                } else {
                    // if no total known, disable next when fewer items than limit returned
                    nextPageBtn.disabled = items.length < limit;
                }
            }

            prevPageBtn.addEventListener('click', ()=>{
                if (offset === 0) return; offset = Math.max(0, offset - limit); fetchUsers();
            });
            nextPageBtn.addEventListener('click', ()=>{
                offset += limit; fetchUsers();
            });

            pageSizeEl.addEventListener('change', ()=>{
                offset = 0; fetchUsers();
            });

            // debounce the search input for better UX
            const debouncedFetch = debounce(()=>{ offset = 0; fetchUsers(); }, 300);
            searchInput.addEventListener('input', debouncedFetch);
            searchInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); offset = 0; fetchUsers(); } });

            modalSave.addEventListener('click', async (e)=>{
                e.preventDefault();
                const id = userIdEl.value && userIdEl.value.trim();
                const payload = {
                    UserId: id || undefined,
                    Email: emailEl.value.trim(),
                    Role: roleEl.value,
                    Password: passwordEl.value || undefined
                };
                try{
                    if (!payload.Email){ showToast('Email is required', { type:'error' }); emailEl.focus(); return; }
                    if (!payload.Role){ showToast('Role is required', { type:'error' }); roleEl.focus(); return; }

                    modalSave.disabled = true; modalSave.setAttribute('aria-busy','true');

                    if (!id){
                        // create
                        const resp = await fetch('/v1/admin/users', {
                            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ Email: payload.Email, Password: payload.Password || '', Role: payload.Role })
                        });
                        if (resp.ok){ showToast('User created'); closeModal(); fetchUsers(); }
                        else { const bt = await resp.text().catch(()=>null); showToast('Create failed: ' + (bt || resp.status), { type:'error' }); }
                    } else {
                        // update
                        const url = `/v1/admin/users/${encodeURIComponent(id)}`;
                        const body = { UserId: id, Email: payload.Email, Role: payload.Role };
                        if (payload.Password) body.Password = payload.Password;
                        const resp = await fetch(url, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                        if (resp.ok){ showToast('User updated'); closeModal(); fetchUsers(); }
                        else { const bt = await resp.text().catch(()=>null); showToast('Update failed: ' + (bt || resp.status), { type:'error' }); }
                    }
                } catch (e){ console.error(e); showToast('Save failed', { type:'error' }); }
                finally { modalSave.disabled = false; modalSave.removeAttribute('aria-busy'); }
            });

            // Accept optional button parameter to disable while deleting
            async function deleteUser(u, btn){
                const id = u.UserId ?? u.userId ?? u.id ?? null;
                if (!id) { showToast('Cannot determine user id', {type:'error'}); return; }
                if (!confirm('Delete user ' + (u.Email ?? u.email ?? id) + '? This action cannot be undone.')) return;
                try{
                    if (btn){ btn.disabled = true; }
                    const url = `/v1/admin/users/${encodeURIComponent(id)}`;
                    const resp = await fetch(url, { method: 'DELETE' });
                    if (resp.ok){ showToast('User deleted'); fetchUsers(); }
                    else { const bt = await resp.text().catch(()=>null); showToast('Delete failed: ' + (bt || resp.status), { type:'error' }); }
                } catch (e){ console.error(e); showToast('Delete failed', { type:'error' }); }
                finally { if (btn) btn.disabled = false; }
            }

            // initial load
            fetchUsers();

        })();
    </script>
</body>
</html>
